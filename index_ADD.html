<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard FormaciÃ³n (Promos ADD â€“ Filtros cruzados + Agrupaciones Bloques)</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background:#fafafa; }
    .btn { cursor:pointer; border:1px solid #ddd; background:#f7f7f7; padding:6px 10px; border-radius:8px; }
    #filtros { margin: 20px 0; display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .buscador { position: relative; display:inline-flex; align-items:center; gap:6px;
      border:1px solid #ddd; padding:6px 10px; border-radius:8px; background:#fff; }
    .buscador input { border:none; outline:none; min-width:260px; }
    .sugerencias {
      position:absolute; top:100%; left:0; right:0; z-index:10; background:#fff;
      border:1px solid #ddd; border-radius:8px; margin-top:4px; max-height:240px; overflow:auto; display:none;
      box-shadow: 0 6px 20px rgba(0,0,0,.08);
    }
    .sug-item { padding:8px 10px; cursor:pointer; }
    .sug-item:hover, .sug-item.active { background:#f3f6f8; }
    .grafico { margin-top: 30px; }
    h1,h2,h3 { color:#004c6d; }
    .footer-actions { margin: 40px 0 10px; display:flex; justify-content:center; }
    .btn-primary { background:#00718f; color:#fff; border:none; padding:10px 18px; font-weight:600; }
    .btn-primary:hover { background:#005f75; }
    .app-version { text-align:center; color:#6b6b6b; font-size:0.85rem; margin-bottom: 20px; }
    .modal-backdrop {
      position: fixed; inset:0; background: rgba(0,0,0,0.45);
      display:none; align-items:center; justify-content:center; z-index:2000;
    }
    .modal-backdrop.active { display:flex; }
    .modal {
      background:#fff; width:min(960px, 92vw); max-height:80vh; overflow:auto;
      border-radius:12px; padding:20px 24px; box-shadow:0 14px 30px rgba(0,0,0,0.25);
    }
    .modal-header { display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .modal-header h2 { margin:0; }
    .modal-close { background:transparent; border:none; font-size:1.4rem; cursor:pointer; }
    .scores-table { width:100%; border-collapse:collapse; margin-top:16px; }
    .scores-table th, .scores-table td { padding:10px 12px; border-bottom:1px solid #e5e5e5; text-align:left; }
    .scores-table th { background:#f3f6f8; position:sticky; top:0; z-index:1; }
    .scores-empty { padding:20px 0; color:#666; text-align:center; }
  </style>
</head>
<body>

  <h1>ðŸ“Š Dashboard FormaciÃ³n (Promociones ADD)</h1>

  <input type="file" id="input-excel" accept=".csv,.xlsx,.xls" />
  <div id="filtros" style="display:none;">
    <div class="buscador" title="Filtra por NIF o nombre (contiene)">
      <span>ðŸ”Ž</span>
      <input id="buscaUsuario" type="text" placeholder="Buscar usuario (NIF o nombre)..." autocomplete="off" />
      <button id="clearUsuario" class="btn" title="Limpiar">âœ–</button>
      <div id="sugerencias" class="sugerencias"></div>
    </div>
    <button class="btn" onclick="resetFiltros()">Quitar filtros</button>
  </div>

  <div class="grafico">
    <h2>% Completado por PromociÃ³n</h2>
    <div id="graficoPromos"></div>
  </div>

  <div class="grafico">
    <h2>% de FinalizaciÃ³n por Usuario</h2>
    <div id="graficoUsuarios"></div>
  </div>

  <div class="grafico">
    <h2>ðŸ§© Actividades entregables</h2>
    <div id="graficoEntregables"></div>
  </div>

  <div class="grafico">
    <h2>ðŸ“š Bloques de Contenidos</h2>
    <div id="graficoBloques"></div>
  </div>
  
  <div class="grafico"><h3>Bloque 1 â€“ Conociendo Analiza</h3><div id="graficoB1"></div></div>
  <div class="grafico"><h3>Bloque 2 â€“ RepresentaciÃ³n bÃ¡sica</h3><div id="graficoB2"></div></div>
  <div class="grafico"><h3>Bloque 3 â€“ EdiciÃ³n de expresiones</h3><div id="graficoB3"></div></div>
  <div class="grafico"><h3>Bloque 4 â€“ AnalÃ­tica avanzada</h3><div id="graficoB4"></div></div>
  <div class="grafico"><h3>Bloque 5 â€“ EVF</h3><div id="graficoB5"></div></div>

  <div class="footer-actions">
    <button id="btnPuntuaciones" class="btn btn-primary">ðŸ“Œ Ver puntuaciones</button>
  </div>
  <div class="app-version" id="appVersion"></div>

  <div id="modalPuntuaciones" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="tituloPuntuaciones">
    <div class="modal">
      <div class="modal-header">
        <h2 id="tituloPuntuaciones">Puntuaciones de alumnos filtrados</h2>
        <button class="modal-close" id="cerrarPuntuaciones" aria-label="Cerrar">âœ–</button>
      </div>
      <div id="contenidoPuntuaciones"></div>
    </div>
  </div>

<script>
/* =========================
   CONFIGURACIÃ“N DE BLOQUES
   ========================= */
const MAPA_BLOQUES_RESTO = {
  "CÃ³mo funcionan las BÃºsquedas Avanzadas": "Bloque 1 Conociendo analiza",
  "QuÃ© es Analiza": "Bloque 1 Conociendo analiza",
  "CÃ³mo se usan los informes de analÃ­tica": "Bloque 1 Conociendo analiza",
  "AnalÃ­tica avanzada: Funciones de cadena": "Bloque 4 AnalÃ­tica avanzada",
  "QuÃ© tipologÃ­as de grÃ¡ficos de anÃ¡lisis y visualizaciÃ³n de datos existen en Analiza": "Bloque 2 RepresentaciÃ³n bÃ¡sica",
  "Ponte a prueba!": "Borrar",
  "CÃ³mo se gestionan las hojas en Analiza": "Bloque 2 RepresentaciÃ³n bÃ¡sica",
  "GeoanalÃ­tica": "Bloque 4 AnalÃ­tica avanzada",
  "AnalÃ­tica de datos personalizados": "Bloque 3 EdiciÃ³n de expresiones",
  "Graba tu pantalla configurando los siguientes ejercicios:": "Borrar",
  "CÃ³mo usar colores personalizados": "Bloque 3 EdiciÃ³n de expresiones",
  "CÃ³mo se configuran las propiedades de los grÃ¡ficos": "Bloque 2 RepresentaciÃ³n bÃ¡sica",
  "CÃ³mo se crean y usan los marcadores": "Bloque 2 RepresentaciÃ³n bÃ¡sica",
  "AnÃ¡lisis de conjunto": "Bloque 3 EdiciÃ³n de expresiones",
  "ConfiguraciÃ³n de expresiones en analiza": "Bloque 3 EdiciÃ³n de expresiones",
  "Operaciones IF y Wildmatch": "Bloque 3 EdiciÃ³n de expresiones",
  "AnalÃ­tica avanzada: Funciones de agregaciÃ³n": "Bloque 4 AnalÃ­tica avanzada",
  "Uso de variables personalizadas en analiza": "Bloque 4 AnalÃ­tica avanzada",
  "CÃ¡lculos y operaciones con fechas": "Bloque 3 EdiciÃ³n de expresiones",
  "CÃ¡lculos con medidas y funciones de agregaciÃ³n": "Bloque 4 AnalÃ­tica avanzada",
  "CÃ³mo se dispone la informaciÃ³n en Analiza": "Bloque 2 RepresentaciÃ³n bÃ¡sica",
  "Solicitud de EvaluaciÃ³n Final_CertificaciÃ³n ADD": "Bloque 5 EVF",
  "Encuesta certificaciÃ³n Analiza": "Bloque 5 EVF"
};

/* =========================
   DASHBOARD PRINCIPAL
   ========================= */
let datos = [];
let usuarioSeleccionadoClick = null;
let promoSeleccionadaClick = null;
let actividadSeleccionadaClick = null;
let ultimoFiltrado = [];
const APP_VERSION = "1.0.0";

const colores = {
  azul: "#00718f",
  turquesa: "#00a5b3",
  grisClaro: "#cccccc"
};

const normaliza = s => (s || "")
  .toString().toLowerCase()
  .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
  .replace(/\s+/g, " ").trim();

const inputExcel = document.getElementById("input-excel");
const inputUsuario = document.getElementById("buscaUsuario");
const contSugs = document.getElementById("sugerencias");
const btnClearUsuario = document.getElementById("clearUsuario");
const btnPuntuaciones = document.getElementById("btnPuntuaciones");
const modalPuntuaciones = document.getElementById("modalPuntuaciones");
const cerrarPuntuaciones = document.getElementById("cerrarPuntuaciones");
const contenidoPuntuaciones = document.getElementById("contenidoPuntuaciones");

document.getElementById("appVersion").textContent = `VersiÃ³n ${APP_VERSION}`;

let userIndex = {}, userList = [];
let usuarioFiltroTexto = "";

inputExcel.addEventListener("change", handleFile);

function handleFile(e) {
  const file = e.target.files[0];
  if (!file) return;
  const name = file.name.toLowerCase();
  const ext = name.split('.').pop();

  function postLoad() {
    construirIndiceUsuarios();
    document.getElementById("filtros").style.display = "flex";
    actualizarGraficos();
  }

  function normalizeKeys(row) {
    const out = {};
    for (const [k, v] of Object.entries(row || {})) {
      const nk = (k || "").replace(/^\uFEFF/, "").trim();
      out[nk] = (typeof v === "string") ? v.trim() : v;
    }
    return out;
  }

  if (ext === "csv") {
    const reader = new FileReader();
    reader.onload = function(ev) {
      const text = ev.target.result;
      const parsed = Papa.parse(text, { header:true, skipEmptyLines:true });
      datos = (parsed.data || []).map(normalizeKeys);
      marcarCompletadosPromo0();
      postLoad();
    };
    reader.readAsText(file, "utf-8");
    return;
  }

  const reader = new FileReader();
  reader.onload = function(e) {
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, { type:"array" });
    const sheetName = workbook.SheetNames[0];
    const sheet = workbook.Sheets[sheetName];
    const raw = XLSX.utils.sheet_to_json(sheet);
    datos = raw.map(normalizeKeys);
    marcarCompletadosPromo0();
    postLoad();
  };
  reader.readAsArrayBuffer(file);
}

// âœ… Marca completados todos los de promociÃ³n ADD00 o ADD0
function marcarCompletadosPromo0() {
  datos = datos.map(d => {
    const promo = d["PromociÃ³n"] ? d["PromociÃ³n"].toString().trim().toUpperCase() : "";
    if (/ADD0{1,2}\b/.test(promo)) {
      d["Estado del material de formaciÃ³n"] = "Completado (forzado)";
    }
    return d;
  });
}

function construirIndiceUsuarios() {
  userIndex = {}; userList = [];
  const ids = [...new Set(datos.map(d => d["Nombre de usuario"]).filter(Boolean))];
  ids.forEach(id => {
    const filas = datos.filter(d => d["Nombre de usuario"] === id);
    const nombre = (filas.map(r => r["Nombre completo"]).find(v => v && v.trim())) || "";
    const display = nombre ? `${id} â€” ${nombre}` : id;
    userIndex[id] = {
      id, nombre, display,
      normId: normaliza(id),
      normNombre: normaliza(nombre),
      normDisplay: normaliza(display)
    };
  });
  userList = Object.keys(userIndex).sort((a,b)=>userIndex[a].normId.localeCompare(userIndex[b].normId));
}

function generarSugerencias(q) {
  const qn = normaliza(q);
  if (!qn) { contSugs.style.display="none"; contSugs.innerHTML=""; return; }
  const matches = [];
  for (const id of userList) {
    const u = userIndex[id];
    if (u.normId.includes(qn) || u.normNombre.includes(qn) || u.normDisplay.includes(qn)) {
      matches.push(u);
      if (matches.length>=8) break;
    }
  }
  if (!matches.length) { contSugs.style.display="none"; contSugs.innerHTML=""; return; }
  contSugs.innerHTML = matches.map((u,idx)=>
    `<div class="sug-item" data-id="${u.id}" data-idx="${idx}">${u.display}</div>`).join("");
  contSugs.style.display="block";
  [...contSugs.querySelectorAll(".sug-item")].forEach(el=>{
    el.addEventListener("click",()=>{ seleccionarUsuario(el.getAttribute("data-id"),true); });
  });
}

inputUsuario.addEventListener("input", ()=>{
  usuarioFiltroTexto = inputUsuario.value;
  usuarioSeleccionadoClick = null;
  generarSugerencias(usuarioFiltroTexto);
  actualizarGraficos();
});
btnClearUsuario.addEventListener("click", ()=>{
  inputUsuario.value=""; usuarioFiltroTexto="";
  usuarioSeleccionadoClick=null; contSugs.style.display="none";
  actualizarGraficos();
});

function seleccionarUsuario(id, sync=false){
  if (!id||!userIndex[id]) return;
  usuarioSeleccionadoClick = (usuarioSeleccionadoClick === id) ? null : id; // toggle
  if (sync){ inputUsuario.value=userIndex[id].display; contSugs.style.display="none"; }
  promoSeleccionadaClick = null;
  actividadSeleccionadaClick = null;
  actualizarGraficos();
}

function extraePromoCodigo(promoRaw){
  if (!promoRaw) return null;
  const m = promoRaw.toString().trim().match(/ADD(\d{1,2})/i);
  if (!m) return null;
  return { code:`ADD${m[1].padStart(2,'0')}`, num:parseInt(m[1],10) };
}

function usuariosCoincidentesPorTexto(){
  const q = normaliza(usuarioFiltroTexto);
  if (!q) return null;
  const set = new Set();
  for (const id of userList){
    const u=userIndex[id];
    if (u.normId.includes(q)||u.normNombre.includes(q)||u.normDisplay.includes(q)) set.add(id);
  }
  return set;
}

function actualizarGraficos(){
  const setUsuariosTexto = usuariosCoincidentesPorTexto();

  // ðŸ”¹ Filtro global
  const filtrados = datos.filter(d=>{
    if (usuarioSeleccionadoClick && d["Nombre de usuario"] !== usuarioSeleccionadoClick) return false;
    if (!usuarioSeleccionadoClick && setUsuariosTexto && !setUsuariosTexto.has(d["Nombre de usuario"])) return false;
    const p = extraePromoCodigo(d["PromociÃ³n"]);
    if (!p) return false;
    if (promoSeleccionadaClick && p.code !== promoSeleccionadaClick) return false;
    if (actividadSeleccionadaClick) {
      const titulo = d["TÃ­tulo del material de formaciÃ³n"];
      if (titulo !== actividadSeleccionadaClick) return false;
    }
    return true;
  });
  ultimoFiltrado = filtrados;

  /* === PROMOCIONES === */
  const promoAgg = {};
  filtrados.forEach(d=>{
    const p=extraePromoCodigo(d["PromociÃ³n"]); if(!p) return;
    const promo=p.code;
    if(!promoAgg[promo]) promoAgg[promo]={comp:0,total:0};
    if(d["Estado del material de formaciÃ³n"]){
      promoAgg[promo].total++;
      if(d["Estado del material de formaciÃ³n"].toLowerCase().includes("complet")) promoAgg[promo].comp++;
    }
  });
  const todasPromos=Object.keys(promoAgg).sort();
  const xP=todasPromos;
  const yP=xP.map(p=>{const a=promoAgg[p];return a.total>0?(a.comp/a.total)*100:0;});
  Plotly.newPlot("graficoPromos",[{
    x:xP,y:yP,type:"bar",marker:{color:colores.turquesa},
    text:yP.map(v=>v.toFixed(1)+"%"),textposition:"inside"
  }],{title:"% Completado por PromociÃ³n",yaxis:{range:[0,100]}});
  document.getElementById("graficoPromos").on('plotly_click',(ev)=>{
    const clicked=ev.points[0].x;
    promoSeleccionadaClick=(promoSeleccionadaClick===clicked)?null:clicked;
    usuarioSeleccionadoClick=null;
    actividadSeleccionadaClick=null;
    actualizarGraficos();
  });

  /* === USUARIOS === */
  const usuarios={};
  filtrados.forEach(d=>{
    const u=d["Nombre de usuario"]; if(!u) return;
    if(!usuarios[u]) usuarios[u]={total:0,comp:0};
    if(d["Estado del material de formaciÃ³n"]){
      usuarios[u].total++;
      if(d["Estado del material de formaciÃ³n"].toLowerCase().includes("complet")) usuarios[u].comp++;
    }
  });
  const xU=Object.keys(usuarios);
  const yU=xU.map(u=>usuarios[u].total>0?(usuarios[u].comp/usuarios[u].total)*100:0);
  Plotly.newPlot("graficoUsuarios",[{
    x:xU.map(u=>userIndex[u]?.display||u),y:yU,type:"bar",marker:{color:colores.azul},
    text:yU.map(v=>v.toFixed(1)+"%"),textposition:"inside"
  }],{title:"% FinalizaciÃ³n por Usuario",yaxis:{range:[0,100]},xaxis:{automargin:true}});
  document.getElementById("graficoUsuarios").on('plotly_click',(ev)=>{
    const idx=ev.points[0].pointIndex;
    const userId=xU[idx];
    seleccionarUsuario(userId,true);
  });

  /* === ACTIVIDADES === */
  const entregables={}, bloques={}, materialesBloque={};
  filtrados.forEach(d=>{
    const titulo=d["TÃ­tulo del material de formaciÃ³n"]; if(!titulo) return;
    const u=d["Nombre de usuario"];
    const esEntregable=/entregable|tarea/i.test(titulo);
    if(esEntregable){
      if(!entregables[titulo]) entregables[titulo]={tot:new Set(),comp:new Set()};
      entregables[titulo].tot.add(u);
      if((d["Estado del material de formaciÃ³n"]||"").toLowerCase().includes("complet")) entregables[titulo].comp.add(u);
    } else {
      const bloque=MAPA_BLOQUES_RESTO[titulo]||"Otros";
      if(bloque==="Borrar") return;
      if(!bloques[bloque]) bloques[bloque]={tot:new Set(),comp:new Set()};
      bloques[bloque].tot.add(u);
      if((d["Estado del material de formaciÃ³n"]||"").toLowerCase().includes("complet")) bloques[bloque].comp.add(u);

      // Agrupar materiales dentro de cada bloque
      if(!materialesBloque[bloque]) materialesBloque[bloque]={};
      if(!materialesBloque[bloque][titulo]) materialesBloque[bloque][titulo]={tot:new Set(),comp:new Set()};
      materialesBloque[bloque][titulo].tot.add(u);
      if((d["Estado del material de formaciÃ³n"]||"").toLowerCase().includes("complet"))
        materialesBloque[bloque][titulo].comp.add(u);
    }
  });

  /* === FUNCIÃ“N AUXILIAR DE GRAFICADO === */
  function graficar(containerId, dataObj, titulo, orient="v"){
    let entries=Object.keys(dataObj).map(k=>{
      const s=dataObj[k];
      const pct=(s.comp.size/s.tot.size)*100;
      return {titulo:k,pct};
    }).filter(e=>!isNaN(e.pct));

    entries.sort((a,b)=>a.titulo.localeCompare(b.titulo));

    const x=entries.map(e=>e.titulo);
    const y=entries.map(e=>e.pct);

    Plotly.newPlot(containerId,[{
      x:orient==="v"?x:y,
      y:orient==="v"?y:x,
      type:"bar",
      orientation:orient==="h"?"h":"v",
      marker:{color:colores.turquesa},
      text:y.map(p=>p.toFixed(1)+"%"),
      textposition:"auto"
    }],{
      title:titulo,
      yaxis:{range:[0,100]},
      xaxis:{automargin:true},
      margin:{l:orient==="h"?220:80,t:40,b:50}
    });

    document.getElementById(containerId).on('plotly_click',(ev)=>{
      const clickedAct=ev.points[0].x;
      actividadSeleccionadaClick=(actividadSeleccionadaClick===clickedAct)?null:clickedAct;
      promoSeleccionadaClick=null;
      usuarioSeleccionadoClick=null;
      actualizarGraficos();
    });
  }

  /* === GRAFICAR === */
  graficar("graficoEntregables",entregables,"Actividades Entregables");
  graficar("graficoBloques",bloques,"Bloques de Contenidos");

  /* === 5 grÃ¡ficos verticales (uno por bloque) === */
["Bloque 1 Conociendo analiza",
 "Bloque 2 RepresentaciÃ³n bÃ¡sica",
 "Bloque 3 EdiciÃ³n de expresiones",
 "Bloque 4 AnalÃ­tica avanzada",
 "Bloque 5 EVF"].forEach((bloque,i)=>{
   if(materialesBloque[bloque])
     graficar(`graficoB${i+1}`,materialesBloque[bloque],bloque,"v");
});
}

function calcularPuntuaciones(filtrados){
  const puntuaciones = {};
  filtrados.forEach(d=>{
    const usuario = d["Nombre de usuario"];
    const titulo = (d["TÃ­tulo del material de formaciÃ³n"] || "").toString();
    const estado = (d["Estado del material de formaciÃ³n"] || "").toLowerCase();
    if (!usuario || !titulo || !estado.includes("complet")) return;

    const esEntregable = /entregable/i.test(titulo);
    const esTest = /test|prueba/i.test(titulo);

    if (!puntuaciones[usuario]) {
      puntuaciones[usuario] = { entregables: new Set(), tests: new Set() };
    }
    if (esEntregable) {
      puntuaciones[usuario].entregables.add(titulo);
    }
    if (esTest) {
      puntuaciones[usuario].tests.add(titulo);
    }
  });

  return Object.keys(puntuaciones).map(usuario => {
    const datosUsuario = puntuaciones[usuario];
    const entregables = datosUsuario.entregables.size;
    const tests = datosUsuario.tests.size;
    const total = entregables * 1 + tests * 2;
    return {
      usuario,
      display: userIndex[usuario]?.display || usuario,
      entregables,
      tests,
      total
    };
  }).sort((a,b)=> b.total - a.total || a.display.localeCompare(b.display));
}

function renderizarPuntuaciones(){
  const resultados = calcularPuntuaciones(ultimoFiltrado);
  if (!resultados.length){
    contenidoPuntuaciones.innerHTML = `<div class="scores-empty">No hay alumnos con entregables o tests completados en el filtro actual.</div>`;
    return;
  }
  const rows = resultados.map(r=>`
    <tr>
      <td>${r.display}</td>
      <td>${r.entregables}</td>
      <td>${r.tests}</td>
      <td><strong>${r.total}</strong></td>
    </tr>
  `).join("");
  contenidoPuntuaciones.innerHTML = `
    <table class="scores-table">
      <thead>
        <tr>
          <th>Alumno</th>
          <th>Entregables (1 p.)</th>
          <th>Tests (2 p.)</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody>
        ${rows}
      </tbody>
    </table>
  `;
}

btnPuntuaciones.addEventListener("click", ()=>{
  renderizarPuntuaciones();
  modalPuntuaciones.classList.add("active");
});

cerrarPuntuaciones.addEventListener("click", ()=>{
  modalPuntuaciones.classList.remove("active");
});

modalPuntuaciones.addEventListener("click", (event)=>{
  if (event.target === modalPuntuaciones) {
    modalPuntuaciones.classList.remove("active");
  }
});


function resetFiltros(){
  usuarioSeleccionadoClick=null;
  promoSeleccionadaClick=null;
  actividadSeleccionadaClick=null;
  inputUsuario.value="";
  usuarioFiltroTexto="";
  contSugs.style.display="none";
  actualizarGraficos();
}
</script>

</body>
</html>
