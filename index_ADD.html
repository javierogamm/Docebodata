<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard FormaciÃ³n (Promos ADD â€“ Filtros cruzados + Agrupaciones Bloques)</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #f5f7fb;
      --surface: #ffffff;
      --surface-alt: #eef2f8;
      --primary: #1f6feb;
      --primary-dark: #174ea6;
      --accent: #14b8a6;
      --text: #0f172a;
      --muted: #64748b;
      --border: #e2e8f0;
      --radius: 16px;
      --radius-sm: 10px;
      --shadow: 0 24px 60px rgba(15, 23, 42, 0.12);
      --shadow-soft: 0 12px 30px rgba(15, 23, 42, 0.08);
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
      margin: 24px;
      background: var(--bg);
      color: var(--text);
    }

    h1 {
      font-size: 2rem;
      margin-bottom: 16px;
      letter-spacing: -0.5px;
    }

    h2, h3 {
      color: var(--text);
      margin-top: 0;
    }

    .btn {
      cursor: pointer;
      border: 1px solid transparent;
      background: var(--surface-alt);
      padding: 8px 14px;
      border-radius: var(--radius-sm);
      font-weight: 600;
      color: var(--text);
      transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.2s ease;
      box-shadow: 0 6px 14px rgba(15, 23, 42, 0.08);
    }

    .btn:hover {
      transform: translateY(-1px);
      background: #e1e8f4;
    }

    .btn:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(31, 111, 235, 0.2);
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary), #3a8dff);
      color: #fff;
      border: none;
      padding: 10px 20px;
      font-weight: 600;
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, #1c5dd9, #2f7df2);
    }

    #filtros {
      margin: 20px 0 24px;
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .buscador {
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border: 1px solid var(--border);
      padding: 8px 12px;
      border-radius: var(--radius-sm);
      background: var(--surface);
      box-shadow: var(--shadow-soft);
    }

    .buscador input {
      border: none;
      outline: none;
      min-width: 260px;
      font-size: 0.95rem;
      background: transparent;
    }

    .sugerencias {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      z-index: 10;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      margin-top: 6px;
      max-height: 240px;
      overflow: auto;
      display: none;
      box-shadow: var(--shadow);
    }

    .sug-item {
      padding: 10px 12px;
      cursor: pointer;
    }

    .sug-item:hover,
    .sug-item.active {
      background: var(--surface-alt);
    }

    .grafico {
      margin-top: 24px;
      background: var(--surface);
      border-radius: var(--radius);
      padding: 18px 20px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-soft);
    }

    .top-actions {
      display: flex;
      justify-content: flex-end;
      margin: 10px 0 20px;
    }

    .app-version {
      text-align: center;
      color: var(--muted);
      font-size: 0.85rem;
      margin: 28px 0 12px;
    }

    input[type="file"] {
      padding: 10px 14px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      background: var(--surface);
      box-shadow: var(--shadow-soft);
      font-family: inherit;
    }

    input[type="file"]::file-selector-button {
      border: none;
      background: var(--primary);
      color: #fff;
      padding: 8px 12px;
      border-radius: 8px;
      margin-right: 12px;
      cursor: pointer;
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.55);
      backdrop-filter: blur(6px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }

    .modal-backdrop.active {
      display: flex;
    }

    .modal {
      background: var(--surface);
      width: min(1400px, 96vw);
      max-height: 90vh;
      overflow: auto;
      border-radius: 20px;
      padding: 24px 28px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .modal-header h2 {
      margin: 0;
      font-size: 1.4rem;
    }

    .modal-close {
      background: var(--surface-alt);
      border: none;
      font-size: 1.1rem;
      cursor: pointer;
      border-radius: 10px;
      padding: 6px 10px;
    }

    .scores-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
      overflow: hidden;
    }

    .scores-table th,
    .scores-table td {
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      text-align: left;
    }

    .scores-table th {
      background: var(--surface-alt);
      position: sticky;
      top: 0;
      z-index: 1;
    }

    .scores-empty {
      padding: 20px 0;
      color: var(--muted);
      text-align: center;
    }

    .teams-section {
      margin-top: 24px;
      border-top: 1px solid var(--border);
      padding-top: 18px;
    }

    .teams-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 12px;
    }

    .teams-header h3 {
      margin: 0;
      color: var(--text);
    }

    .teams-controls {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .teams-controls select {
      padding: 6px 10px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      background: var(--surface);
    }

    .btn-suggest {
      padding: 8px 12px;
    }

    .teams-help {
      margin: 8px 0 0;
      color: var(--muted);
      font-size: 0.92rem;
    }

    .teams-board {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 14px;
      margin-top: 12px;
    }

    .team-column {
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--surface-alt);
      padding: 12px;
      min-height: 220px;
      display: flex;
      flex-direction: column;
      box-shadow: var(--shadow-soft);
    }

    .team-column h4 {
      margin: 0 0 10px;
      font-size: 1rem;
      color: var(--text);
    }

    .team-dropzone {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 120px;
      padding: 6px;
      border-radius: 12px;
    }

    .team-dropzone.drag-over {
      border: 2px dashed var(--primary);
      background: rgba(31, 111, 235, 0.08);
    }

    .team-member {
      padding: 10px 12px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      cursor: grab;
      box-shadow: 0 6px 16px rgba(15, 23, 42, 0.12);
      transition: transform 0.1s ease;
    }

    .team-member:hover {
      transform: translateY(-1px);
    }

    .team-member:active {
      cursor: grabbing;
    }

    .team-member.dragging {
      opacity: 0.5;
    }

    .team-member.auto-assign {
      animation: autoDrop 0.3s ease;
    }

    .team-member.open {
      cursor: default;
    }

    .member-name {
      font-weight: 600;
      color: var(--text);
    }

    .role-tag {
      margin-top: 4px;
      font-size: 0.78rem;
      color: var(--muted);
    }

    .role-tag.role-legal {
      color: #41548b;
      background: #e8edff;
      border-radius: 999px;
      padding: 2px 8px;
      display: inline-block;
    }

    .role-tag.role-tech {
      color: #1f6b6b;
      background: #dff7f4;
      border-radius: 999px;
      padding: 2px 8px;
      display: inline-block;
    }

    .role-tag.role-admin {
      color: #7a5c26;
      background: #fff4d6;
      border-radius: 999px;
      padding: 2px 8px;
      display: inline-block;
    }

    .role-tag.role-archivo {
      color: #5b3c9d;
      background: #f0e9ff;
      border-radius: 999px;
      padding: 2px 8px;
      display: inline-block;
    }

    .role-tag.role-economico {
      color: #1c7f4f;
      background: #e3f7ed;
      border-radius: 999px;
      padding: 2px 8px;
      display: inline-block;
    }

    .role-select {
      margin-top: 6px;
      width: 100%;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: 0.82rem;
      display: none;
      background: var(--surface);
    }

    .team-member.open .role-select {
      display: block;
    }

    .team-member.role-legal {
      border-color: #c7d4ff;
      background: #f5f7ff;
    }

    .team-member.role-tech {
      border-color: #b8efe8;
      background: #f1fbfa;
    }

    .team-member.role-admin {
      border-color: #f3e0b2;
      background: #fff9ec;
    }

    .team-member.role-archivo {
      border-color: #d7c8f5;
      background: #f8f4ff;
    }

    .team-member.role-economico {
      border-color: #bfe8d3;
      background: #f2fbf6;
    }

    .team-dropzone.auto-assign {
      background: rgba(20, 184, 166, 0.12);
      transition: background 0.3s ease;
    }

    @keyframes autoDrop {
      from {
        transform: translateY(-8px);
        opacity: 0.6;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
  </style>
</head>
<body>

  <h1>ðŸ“Š Dashboard FormaciÃ³n (Promociones ADD)</h1>

  <div class="top-actions">
    <button id="btnPuntuaciones" class="btn btn-primary">ðŸ“Œ Ver puntuaciones</button>
  </div>

  <input type="file" id="input-excel" accept=".csv,.xlsx,.xls" />
  <div id="filtros" style="display:none;">
    <div class="buscador" title="Filtra por NIF o nombre (contiene)">
      <span>ðŸ”Ž</span>
      <input id="buscaUsuario" type="text" placeholder="Buscar usuario (NIF o nombre)..." autocomplete="off" />
      <button id="clearUsuario" class="btn" title="Limpiar">âœ–</button>
      <div id="sugerencias" class="sugerencias"></div>
    </div>
    <button class="btn" onclick="resetFiltros()">Quitar filtros</button>
  </div>

  <div class="grafico">
    <h2>% Completado por PromociÃ³n</h2>
    <div id="graficoPromos"></div>
  </div>

  <div class="grafico">
    <h2>% de FinalizaciÃ³n por Usuario</h2>
    <div id="graficoUsuarios"></div>
  </div>

  <div class="grafico">
    <h2>ðŸ§© Actividades entregables</h2>
    <div id="graficoEntregables"></div>
  </div>

  <div class="grafico">
    <h2>ðŸ“š Bloques de Contenidos</h2>
    <div id="graficoBloques"></div>
  </div>
  
  <div class="grafico"><h3>Bloque 1 â€“ Conociendo Analiza</h3><div id="graficoB1"></div></div>
  <div class="grafico"><h3>Bloque 2 â€“ RepresentaciÃ³n bÃ¡sica</h3><div id="graficoB2"></div></div>
  <div class="grafico"><h3>Bloque 3 â€“ EdiciÃ³n de expresiones</h3><div id="graficoB3"></div></div>
  <div class="grafico"><h3>Bloque 4 â€“ AnalÃ­tica avanzada</h3><div id="graficoB4"></div></div>
  <div class="grafico"><h3>Bloque 5 â€“ EVF</h3><div id="graficoB5"></div></div>

  <div class="app-version" id="appVersion"></div>

  <div id="modalPuntuaciones" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="tituloPuntuaciones">
    <div class="modal">
      <div class="modal-header">
        <h2 id="tituloPuntuaciones">Puntuaciones de alumnos filtrados</h2>
        <button class="modal-close" id="cerrarPuntuaciones" aria-label="Cerrar">âœ–</button>
      </div>
      <div id="contenidoPuntuaciones"></div>
    </div>
  </div>

<script>
/* =========================
   CONFIGURACIÃ“N DE BLOQUES
   ========================= */
const MAPA_BLOQUES_RESTO = {
  "CÃ³mo funcionan las BÃºsquedas Avanzadas": "Bloque 1 Conociendo analiza",
  "QuÃ© es Analiza": "Bloque 1 Conociendo analiza",
  "CÃ³mo se usan los informes de analÃ­tica": "Bloque 1 Conociendo analiza",
  "AnalÃ­tica avanzada: Funciones de cadena": "Bloque 4 AnalÃ­tica avanzada",
  "QuÃ© tipologÃ­as de grÃ¡ficos de anÃ¡lisis y visualizaciÃ³n de datos existen en Analiza": "Bloque 2 RepresentaciÃ³n bÃ¡sica",
  "Ponte a prueba!": "Borrar",
  "CÃ³mo se gestionan las hojas en Analiza": "Bloque 2 RepresentaciÃ³n bÃ¡sica",
  "GeoanalÃ­tica": "Bloque 4 AnalÃ­tica avanzada",
  "AnalÃ­tica de datos personalizados": "Bloque 3 EdiciÃ³n de expresiones",
  "Graba tu pantalla configurando los siguientes ejercicios:": "Borrar",
  "CÃ³mo usar colores personalizados": "Bloque 3 EdiciÃ³n de expresiones",
  "CÃ³mo se configuran las propiedades de los grÃ¡ficos": "Bloque 2 RepresentaciÃ³n bÃ¡sica",
  "CÃ³mo se crean y usan los marcadores": "Bloque 2 RepresentaciÃ³n bÃ¡sica",
  "AnÃ¡lisis de conjunto": "Bloque 3 EdiciÃ³n de expresiones",
  "ConfiguraciÃ³n de expresiones en analiza": "Bloque 3 EdiciÃ³n de expresiones",
  "Operaciones IF y Wildmatch": "Bloque 3 EdiciÃ³n de expresiones",
  "AnalÃ­tica avanzada: Funciones de agregaciÃ³n": "Bloque 4 AnalÃ­tica avanzada",
  "Uso de variables personalizadas en analiza": "Bloque 4 AnalÃ­tica avanzada",
  "CÃ¡lculos y operaciones con fechas": "Bloque 3 EdiciÃ³n de expresiones",
  "CÃ¡lculos con medidas y funciones de agregaciÃ³n": "Bloque 4 AnalÃ­tica avanzada",
  "CÃ³mo se dispone la informaciÃ³n en Analiza": "Bloque 2 RepresentaciÃ³n bÃ¡sica",
  "Solicitud de EvaluaciÃ³n Final_CertificaciÃ³n ADD": "Bloque 5 EVF",
  "Encuesta certificaciÃ³n Analiza": "Bloque 5 EVF"
};

/* =========================
   DASHBOARD PRINCIPAL
   ========================= */
let datos = [];
let usuarioSeleccionadoClick = null;
let promoSeleccionadaClick = null;
let actividadSeleccionadaClick = null;
let ultimoFiltrado = [];
const APP_VERSION = "1.0.15";
const TEAM_CONFIG = {
  3: ["Equipo Rojo", "Equipo MarrÃ³n", "Equipo Verde"],
  4: ["Equipo Rojo", "Equipo MarrÃ³n", "Equipo Verde", "Equipo Ladrillosco"]
};
let teamCount = 3;
let teamAssignments = new Map();
let userRoles = new Map();

const colores = {
  azul: "#00718f",
  turquesa: "#00a5b3",
  grisClaro: "#cccccc"
};
const ROLE_OPTIONS = [
  { value: "", label: "Sin perfil" },
  { value: "legal", label: "Perfil JurÃ­dico", className: "role-legal" },
  { value: "tech", label: "Perfil InformÃ¡tico", className: "role-tech" },
  { value: "admin", label: "Perfil Administrativo", className: "role-admin" },
  { value: "archivo", label: "Perfil Archivo", className: "role-archivo" },
  { value: "economico", label: "Perfil EconÃ³mico", className: "role-economico" }
];
const ROLE_LABELS = ROLE_OPTIONS.reduce((acc, item) => {
  acc[item.value] = item.label;
  return acc;
}, {});
const ROLE_CLASSES = ROLE_OPTIONS.reduce((acc, item) => {
  if (item.className) acc[item.value] = item.className;
  return acc;
}, {});

const normaliza = s => (s || "")
  .toString().toLowerCase()
  .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
  .replace(/\s+/g, " ").trim();

function obtenerCampo(filas, keys) {
  for (const key of keys) {
    const value = filas.map(r => r[key]).find(v => v && v.trim());
    if (value) return value;
  }
  return "";
}

const inputExcel = document.getElementById("input-excel");
const inputUsuario = document.getElementById("buscaUsuario");
const contSugs = document.getElementById("sugerencias");
const btnClearUsuario = document.getElementById("clearUsuario");
const btnPuntuaciones = document.getElementById("btnPuntuaciones");
const modalPuntuaciones = document.getElementById("modalPuntuaciones");
const cerrarPuntuaciones = document.getElementById("cerrarPuntuaciones");
const contenidoPuntuaciones = document.getElementById("contenidoPuntuaciones");

document.getElementById("appVersion").textContent = `VersiÃ³n ${APP_VERSION}`;

let userIndex = {}, userList = [];
let usuarioFiltroTexto = "";

inputExcel.addEventListener("change", handleFile);

function handleFile(e) {
  const file = e.target.files[0];
  if (!file) return;
  const name = file.name.toLowerCase();
  const ext = name.split('.').pop();

  function postLoad() {
    construirIndiceUsuarios();
    document.getElementById("filtros").style.display = "flex";
    actualizarGraficos();
  }

  function normalizeKeys(row) {
    const out = {};
    for (const [k, v] of Object.entries(row || {})) {
      const nk = (k || "")
        .replace(/^\uFEFF/, "")
        .replace(/^"+|"+$/g, "")
        .trim();
      out[nk] = (typeof v === "string") ? v.trim() : v;
    }
    return out;
  }

  if (ext === "csv") {
    const reader = new FileReader();
    reader.onload = function(ev) {
      const text = ev.target.result;
      const parsed = Papa.parse(text, { header:true, skipEmptyLines:true });
      datos = (parsed.data || []).map(normalizeKeys);
      marcarCompletadosPromo0();
      postLoad();
    };
    reader.readAsText(file, "utf-8");
    return;
  }

  const reader = new FileReader();
  reader.onload = function(e) {
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, { type:"array" });
    const sheetName = workbook.SheetNames[0];
    const sheet = workbook.Sheets[sheetName];
    const raw = XLSX.utils.sheet_to_json(sheet);
    datos = raw.map(normalizeKeys);
    marcarCompletadosPromo0();
    postLoad();
  };
  reader.readAsArrayBuffer(file);
}

// âœ… Marca completados todos los de promociÃ³n ADD00 o ADD0
function marcarCompletadosPromo0() {
  datos = datos.map(d => {
    const promo = d["PromociÃ³n"] ? d["PromociÃ³n"].toString().trim().toUpperCase() : "";
    if (/ADD0{1,2}\b/.test(promo)) {
      d["Estado del material de formaciÃ³n"] = "Completado (forzado)";
    }
    return d;
  });
}

function construirIndiceUsuarios() {
  userIndex = {}; userList = [];
  const ids = [...new Set(datos.map(d => d["Nombre de usuario"]).filter(Boolean))];
  ids.forEach(id => {
    const filas = datos.filter(d => d["Nombre de usuario"] === id);
    const nombre = (filas.map(r => r["Nombre completo"]).find(v => v && v.trim())) || "";
    const entidad = obtenerCampo(filas, ["Entidad", "ENTIDAD"]);
    const display = nombre ? `${id} â€” ${nombre}` : id;
    userIndex[id] = {
      id, nombre, entidad, display,
      normId: normaliza(id),
      normNombre: normaliza(nombre),
      normDisplay: normaliza(display)
    };
  });
  userList = Object.keys(userIndex).sort((a,b)=>userIndex[a].normId.localeCompare(userIndex[b].normId));
}

function generarSugerencias(q) {
  const qn = normaliza(q);
  if (!qn) { contSugs.style.display="none"; contSugs.innerHTML=""; return; }
  const matches = [];
  for (const id of userList) {
    const u = userIndex[id];
    if (u.normId.includes(qn) || u.normNombre.includes(qn) || u.normDisplay.includes(qn)) {
      matches.push(u);
      if (matches.length>=8) break;
    }
  }
  if (!matches.length) { contSugs.style.display="none"; contSugs.innerHTML=""; return; }
  contSugs.innerHTML = matches.map((u,idx)=>
    `<div class="sug-item" data-id="${u.id}" data-idx="${idx}">${u.display}</div>`).join("");
  contSugs.style.display="block";
  [...contSugs.querySelectorAll(".sug-item")].forEach(el=>{
    el.addEventListener("click",()=>{ seleccionarUsuario(el.getAttribute("data-id"),true); });
  });
}

inputUsuario.addEventListener("input", ()=>{
  usuarioFiltroTexto = inputUsuario.value;
  usuarioSeleccionadoClick = null;
  generarSugerencias(usuarioFiltroTexto);
  actualizarGraficos();
});
btnClearUsuario.addEventListener("click", ()=>{
  inputUsuario.value=""; usuarioFiltroTexto="";
  usuarioSeleccionadoClick=null; contSugs.style.display="none";
  actualizarGraficos();
});

function seleccionarUsuario(id, sync=false){
  if (!id||!userIndex[id]) return;
  usuarioSeleccionadoClick = (usuarioSeleccionadoClick === id) ? null : id; // toggle
  if (sync){ inputUsuario.value=userIndex[id].display; contSugs.style.display="none"; }
  promoSeleccionadaClick = null;
  actividadSeleccionadaClick = null;
  actualizarGraficos();
}

function extraePromoCodigo(promoRaw){
  if (!promoRaw) return null;
  const m = promoRaw.toString().trim().match(/ADD(\d{1,2})/i);
  if (!m) return null;
  return { code:`ADD${m[1].padStart(2,'0')}`, num:parseInt(m[1],10) };
}

function usuariosCoincidentesPorTexto(){
  const q = normaliza(usuarioFiltroTexto);
  if (!q) return null;
  const set = new Set();
  for (const id of userList){
    const u=userIndex[id];
    if (u.normId.includes(q)||u.normNombre.includes(q)||u.normDisplay.includes(q)) set.add(id);
  }
  return set;
}

const normalizaEntregable = s => (s || "")
  .toString()
  .toLowerCase()
  .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
  .replace(/\s+/g, " ")
  .trim();
const ENTREGABLES_ACTIVIDADES_SET = new Set([
  "Actividad 01",
  "Actividad 02",
  "Actividades TALLER 01. BÃºsquedas Avanzadas. Conceptos y opciones disponibles Instrucciones",
  "Actividades TALLER 02. Gestiona Analiza. Conceptos y primeros pasos de configuraciÃ³n"
].map(normalizaEntregable));
const obtenerNumeroTaller = (titulo = "") => {
  const match = titulo.match(/taller(?: online)?\s*0*(\d+)/i);
  return match ? parseInt(match[1], 10) : Number.POSITIVE_INFINITY;
};
const obtenerNumeroTarea = (titulo = "") => {
  const match = titulo.match(/tarea\s*0*(\d+)/i);
  return match ? parseInt(match[1], 10) : Number.POSITIVE_INFINITY;
};
const obtenerNumeroEntregable = (titulo = "") => {
  const match = titulo.match(/entregable.*?(\d+)/i);
  return match ? parseInt(match[1], 10) : Number.POSITIVE_INFINITY;
};

function actualizarGraficos(){
  const setUsuariosTexto = usuariosCoincidentesPorTexto();

  // ðŸ”¹ Filtro global
  const filtrados = datos.filter(d=>{
    if (usuarioSeleccionadoClick && d["Nombre de usuario"] !== usuarioSeleccionadoClick) return false;
    if (!usuarioSeleccionadoClick && setUsuariosTexto && !setUsuariosTexto.has(d["Nombre de usuario"])) return false;
    const p = extraePromoCodigo(d["PromociÃ³n"]);
    if (!p) return false;
    if (promoSeleccionadaClick && p.code !== promoSeleccionadaClick) return false;
    if (actividadSeleccionadaClick) {
      const titulo = d["TÃ­tulo del material de formaciÃ³n"];
      if (titulo !== actividadSeleccionadaClick) return false;
    }
    return true;
  });
  ultimoFiltrado = filtrados;

  /* === PROMOCIONES === */
  const promoAgg = {};
  filtrados.forEach(d=>{
    const p=extraePromoCodigo(d["PromociÃ³n"]); if(!p) return;
    const promo=p.code;
    if(!promoAgg[promo]) promoAgg[promo]={comp:0,total:0};
    if(d["Estado del material de formaciÃ³n"]){
      promoAgg[promo].total++;
      if(d["Estado del material de formaciÃ³n"].toLowerCase().includes("complet")) promoAgg[promo].comp++;
    }
  });
  const todasPromos=Object.keys(promoAgg).sort();
  const xP=todasPromos;
  const yP=xP.map(p=>{const a=promoAgg[p];return a.total>0?(a.comp/a.total)*100:0;});
  Plotly.newPlot("graficoPromos",[{
    x:xP,y:yP,type:"bar",marker:{color:colores.turquesa},
    text:yP.map(v=>v.toFixed(1)+"%"),textposition:"inside"
  }],{title:"% Completado por PromociÃ³n",yaxis:{range:[0,100]}});
  document.getElementById("graficoPromos").on('plotly_click',(ev)=>{
    const clicked=ev.points[0].x;
    promoSeleccionadaClick=(promoSeleccionadaClick===clicked)?null:clicked;
    usuarioSeleccionadoClick=null;
    actividadSeleccionadaClick=null;
    actualizarGraficos();
  });

  /* === USUARIOS === */
  const usuarios={};
  filtrados.forEach(d=>{
    const u=d["Nombre de usuario"]; if(!u) return;
    if(!usuarios[u]) usuarios[u]={total:0,comp:0};
    if(d["Estado del material de formaciÃ³n"]){
      usuarios[u].total++;
      if(d["Estado del material de formaciÃ³n"].toLowerCase().includes("complet")) usuarios[u].comp++;
    }
  });
  const xU=Object.keys(usuarios);
  const yU=xU.map(u=>usuarios[u].total>0?(usuarios[u].comp/usuarios[u].total)*100:0);
  Plotly.newPlot("graficoUsuarios",[{
    x:xU.map(u=>userIndex[u]?.display||u),y:yU,type:"bar",marker:{color:colores.azul},
    text:yU.map(v=>v.toFixed(1)+"%"),textposition:"inside"
  }],{title:"% FinalizaciÃ³n por Usuario",yaxis:{range:[0,100]},xaxis:{automargin:true}});
  document.getElementById("graficoUsuarios").on('plotly_click',(ev)=>{
    const idx=ev.points[0].pointIndex;
    const userId=xU[idx];
    seleccionarUsuario(userId,true);
  });

  /* === ACTIVIDADES === */
  const entregables={}, bloques={}, materialesBloque={};
  filtrados.forEach(d=>{
    const titulo=d["TÃ­tulo del material de formaciÃ³n"]; if(!titulo) return;
    const u=d["Nombre de usuario"];
    const esEntregable=/entregable|tarea/i.test(titulo) || ENTREGABLES_ACTIVIDADES_SET.has(normalizaEntregable(titulo));
    if(esEntregable){
      if(!entregables[titulo]) entregables[titulo]={tot:new Set(),comp:new Set()};
      entregables[titulo].tot.add(u);
      if((d["Estado del material de formaciÃ³n"]||"").toLowerCase().includes("complet")) entregables[titulo].comp.add(u);
    } else {
      const bloque=MAPA_BLOQUES_RESTO[titulo]||"Otros";
      if(bloque==="Borrar") return;
      if(!bloques[bloque]) bloques[bloque]={tot:new Set(),comp:new Set()};
      bloques[bloque].tot.add(u);
      if((d["Estado del material de formaciÃ³n"]||"").toLowerCase().includes("complet")) bloques[bloque].comp.add(u);

      // Agrupar materiales dentro de cada bloque
      if(!materialesBloque[bloque]) materialesBloque[bloque]={};
      if(!materialesBloque[bloque][titulo]) materialesBloque[bloque][titulo]={tot:new Set(),comp:new Set()};
      materialesBloque[bloque][titulo].tot.add(u);
      if((d["Estado del material de formaciÃ³n"]||"").toLowerCase().includes("complet"))
        materialesBloque[bloque][titulo].comp.add(u);
    }
  });

  /* === FUNCIÃ“N AUXILIAR DE GRAFICADO === */
  function graficar(containerId, dataObj, titulo, orient="v"){
    let entries=Object.keys(dataObj).map(k=>{
      const s=dataObj[k];
      const pct=(s.comp.size/s.tot.size)*100;
      return {titulo:k,pct};
    }).filter(e=>!isNaN(e.pct));

    if (containerId === "graficoEntregables") {
      entries.sort((a, b) => {
        const normA = normalizaEntregable(a.titulo);
        const normB = normalizaEntregable(b.titulo);
        const esActividadA = ENTREGABLES_ACTIVIDADES_SET.has(normA);
        const esActividadB = ENTREGABLES_ACTIVIDADES_SET.has(normB);
        if (esActividadA !== esActividadB) return esActividadA ? -1 : 1;
        const numTallerA = obtenerNumeroTaller(a.titulo);
        const numTallerB = obtenerNumeroTaller(b.titulo);
        if (numTallerA !== numTallerB) return numTallerA - numTallerB;
        const numTareaA = obtenerNumeroTarea(a.titulo);
        const numTareaB = obtenerNumeroTarea(b.titulo);
        if (numTareaA !== numTareaB) return numTareaA - numTareaB;
        const numEntregableA = obtenerNumeroEntregable(a.titulo);
        const numEntregableB = obtenerNumeroEntregable(b.titulo);
        if (numEntregableA !== numEntregableB) return numEntregableA - numEntregableB;
        return a.titulo.localeCompare(b.titulo, "es");
      });
    } else {
      entries.sort((a,b)=>a.titulo.localeCompare(b.titulo));
    }

    const x=entries.map(e=>e.titulo);
    const y=entries.map(e=>e.pct);

    Plotly.newPlot(containerId,[{
      x:orient==="v"?x:y,
      y:orient==="v"?y:x,
      type:"bar",
      orientation:orient==="h"?"h":"v",
      marker:{color:colores.turquesa},
      text:y.map(p=>p.toFixed(1)+"%"),
      textposition:"auto"
    }],{
      title:titulo,
      yaxis:{range:[0,100]},
      xaxis:{automargin:true},
      margin:{l:orient==="h"?220:80,t:40,b:50}
    });

    document.getElementById(containerId).on('plotly_click',(ev)=>{
      const clickedAct=ev.points[0].x;
      actividadSeleccionadaClick=(actividadSeleccionadaClick===clickedAct)?null:clickedAct;
      promoSeleccionadaClick=null;
      usuarioSeleccionadoClick=null;
      actualizarGraficos();
    });
  }

  /* === GRAFICAR === */
  graficar("graficoEntregables",entregables,"Actividades Entregables");
  graficar("graficoBloques",bloques,"Bloques de Contenidos");

  /* === 5 grÃ¡ficos verticales (uno por bloque) === */
["Bloque 1 Conociendo analiza",
 "Bloque 2 RepresentaciÃ³n bÃ¡sica",
 "Bloque 3 EdiciÃ³n de expresiones",
 "Bloque 4 AnalÃ­tica avanzada",
 "Bloque 5 EVF"].forEach((bloque,i)=>{
   if(materialesBloque[bloque])
     graficar(`graficoB${i+1}`,materialesBloque[bloque],bloque,"v");
});
}

function calcularPuntuaciones(filtrados){
  const puntuaciones = {};
  filtrados.forEach(d=>{
    const usuario = d["Nombre de usuario"];
    const titulo = (d["TÃ­tulo del material de formaciÃ³n"] || "").toString();
    const estado = (d["Estado del material de formaciÃ³n"] || "").toLowerCase();
    if (!usuario || !titulo || !estado.includes("complet")) return;

    const esEntregable = /entregable/i.test(titulo);
    const esTest = /test|prueba/i.test(titulo);

    if (!puntuaciones[usuario]) {
      puntuaciones[usuario] = { entregables: new Set(), tests: new Set() };
    }
    if (esEntregable) {
      puntuaciones[usuario].entregables.add(titulo);
    }
    if (esTest) {
      puntuaciones[usuario].tests.add(titulo);
    }
  });

  return Object.keys(puntuaciones).map(usuario => {
    const datosUsuario = puntuaciones[usuario];
    const entregables = datosUsuario.entregables.size;
    const tests = datosUsuario.tests.size;
    const total = entregables * 1 + tests * 2;
    return {
      usuario,
      nombre: userIndex[usuario]?.nombre || "",
      display: userIndex[usuario]?.display || usuario,
      entidad: userIndex[usuario]?.entidad || "",
      entregables,
      tests,
      total
    };
  }).sort((a,b)=> b.total - a.total || a.display.localeCompare(b.display));
}

function construirAsignacionSugerida(alumnos, teamNames) {
  const entityCounts = new Map();
  alumnos.forEach(alumno => {
    const key = normaliza(alumno.entidad || "");
    alumno.entidadKey = key;
    if (!key) return;
    entityCounts.set(key, (entityCounts.get(key) || 0) + 1);
  });

  const teamStats = new Map();
  const totalAlumnos = alumnos.length;
  const baseSize = Math.floor(totalAlumnos / teamNames.length);
  const extra = totalAlumnos % teamNames.length;
  const teamCaps = new Map();
  teamNames.forEach((team, index) => {
    teamStats.set(team, { score: 0, miembros: 0, entidades: new Set(), roles: new Map() });
    teamCaps.set(team, baseSize + (index < extra ? 1 : 0));
  });

  const assignments = new Map();
  const entidadPuedeRepetir = (key) => (entityCounts.get(key) || 0) > teamNames.length;

  const elegirEquipo = (alumno, preferredIndex = null) => {
    const allowRepeat = !alumno.entidadKey || entidadPuedeRepetir(alumno.entidadKey);
    const candidates = teamNames.filter(team => {
      const stats = teamStats.get(team);
      const cap = teamCaps.get(team);
      const hasSpace = stats.miembros < cap;
      return hasSpace && (allowRepeat || !stats.entidades.has(alumno.entidadKey));
    });
    const posibles = candidates.length ? candidates : teamNames.filter(team => {
      const stats = teamStats.get(team);
      return stats.miembros < teamCaps.get(team);
    });
    const fallback = posibles.length ? posibles : teamNames;
    if (preferredIndex !== null) {
      for (let offset = 0; offset < teamNames.length; offset += 1) {
        const team = teamNames[(preferredIndex + offset) % teamNames.length];
        if (fallback.includes(team)) return team;
      }
    }
    return fallback.reduce((best, team) => {
      const stats = teamStats.get(team);
      const bestStats = teamStats.get(best);
      if (alumno.role) {
        const roleCount = stats.roles.get(alumno.role) || 0;
        const bestRoleCount = bestStats.roles.get(alumno.role) || 0;
        if (roleCount !== bestRoleCount) {
          return roleCount < bestRoleCount ? team : best;
        }
      }
      if (stats.score !== bestStats.score) {
        return stats.score < bestStats.score ? team : best;
      }
      if (stats.miembros !== bestStats.miembros) {
        return stats.miembros < bestStats.miembros ? team : best;
      }
      return team;
    }, fallback[0]);
  };

  const ordenar = [...alumnos].sort((a, b) => b.score - a.score || a.nombre.localeCompare(b.nombre));
  const seedCount = Math.min(teamNames.length, ordenar.length);

  const asignar = (alumno, team) => {
    assignments.set(alumno.id, team);
    const stats = teamStats.get(team);
    stats.score += alumno.score;
    stats.miembros += 1;
    if (alumno.entidadKey) stats.entidades.add(alumno.entidadKey);
    if (alumno.role) {
      stats.roles.set(alumno.role, (stats.roles.get(alumno.role) || 0) + 1);
    }
  };

  for (let i = 0; i < seedCount; i += 1) {
    const alumno = ordenar[i];
    const team = elegirEquipo(alumno, i);
    asignar(alumno, team);
  }

  for (let i = seedCount; i < ordenar.length; i += 1) {
    const alumno = ordenar[i];
    const team = elegirEquipo(alumno);
    asignar(alumno, team);
  }

  return assignments;
}

function animarAutoAsignacion(teamBoard, assignments) {
  const cards = [...teamBoard.querySelectorAll(".team-member")];
  const cardsById = new Map(cards.map(card => [card.dataset.student, card]));
  const zones = new Map(
    [...teamBoard.querySelectorAll(".team-dropzone")].map(zone => [zone.dataset.team, zone])
  );
  let delay = 0;
  assignments.forEach((team, id) => {
    const card = cardsById.get(id);
    const zone = zones.get(team);
    if (!card || !zone) return;
    if (card.closest(".team-dropzone") !== zone) {
      zone.appendChild(card);
    }
    const localDelay = delay;
    setTimeout(() => {
      card.classList.add("auto-assign");
      zone.classList.add("auto-assign");
      setTimeout(() => {
        card.classList.remove("auto-assign");
        zone.classList.remove("auto-assign");
      }, 300);
    }, localDelay);
    delay += 60;
  });
}

function inicializarEquipos(resultados) {
  const alumnos = resultados.map(r => ({
    id: r.usuario,
    nombre: r.nombre || r.display,
    entidad: r.entidad,
    score: r.total,
    role: userRoles.get(r.usuario) || ""
  }));
  const teamSelect = document.getElementById("teamCount");
  const suggestButton = document.getElementById("suggestTeams");
  const teamBoard = document.getElementById("teamsBoard");
  if (!teamSelect || !teamBoard) return;

  teamSelect.value = String(teamCount);
  teamSelect.addEventListener("change", (event) => {
    teamCount = Number(event.target.value) || 3;
    renderizarTableroEquipos(teamBoard, alumnos);
  });

  if (suggestButton) {
    suggestButton.addEventListener("click", () => {
      const teamNames = TEAM_CONFIG[teamCount] || TEAM_CONFIG[3];
      teamAssignments = construirAsignacionSugerida(alumnos, teamNames);
      renderizarTableroEquipos(teamBoard, alumnos);
      animarAutoAsignacion(teamBoard, teamAssignments);
    });
  }

  renderizarTableroEquipos(teamBoard, alumnos);
}

function renderizarTableroEquipos(teamBoard, alumnos) {
  const teamNames = TEAM_CONFIG[teamCount] || TEAM_CONFIG[3];
  const alumnosIds = new Set(alumnos.map(a => a.id));

  teamAssignments = new Map(
    [...teamAssignments.entries()].filter(([id]) => alumnosIds.has(id))
  );
  for (const [id, team] of teamAssignments.entries()) {
    if (!teamNames.includes(team)) {
      teamAssignments.delete(id);
    }
  }

  const asignados = new Map();
  teamNames.forEach(team => asignados.set(team, []));
  const sinEquipo = [];

  alumnos.forEach(alumno => {
    const team = teamAssignments.get(alumno.id);
    if (team && asignados.has(team)) {
      asignados.get(team).push(alumno);
    } else {
      sinEquipo.push(alumno);
    }
  });

  teamBoard.innerHTML = "";
  teamBoard.appendChild(crearColumnaEquipo("Sin equipo", "unassigned", sinEquipo));
  teamNames.forEach(team => {
    teamBoard.appendChild(crearColumnaEquipo(team, team, asignados.get(team)));
  });

  habilitarDragAndDrop(teamBoard);
}

function crearColumnaEquipo(titulo, teamKey, alumnos) {
  const column = document.createElement("div");
  column.className = "team-column";

  const heading = document.createElement("h4");
  heading.textContent = titulo;
  column.appendChild(heading);

  const dropzone = document.createElement("div");
  dropzone.className = "team-dropzone";
  dropzone.dataset.team = teamKey;
  alumnos.forEach(alumno => {
    dropzone.appendChild(crearTarjetaAlumno(alumno));
  });
  column.appendChild(dropzone);

  return column;
}

function crearTarjetaAlumno(alumno) {
  const card = document.createElement("div");
  card.className = "team-member";
  card.draggable = true;
  card.dataset.student = alumno.id;
  const nombre = alumno.nombre || alumno.id;

  const nameLine = document.createElement("div");
  nameLine.className = "member-name";
  nameLine.textContent = alumno.entidad ? `${nombre} â€” ${alumno.entidad}` : nombre;
  card.appendChild(nameLine);

  const roleTag = document.createElement("div");
  roleTag.className = "role-tag";
  card.appendChild(roleTag);

  const select = document.createElement("select");
  select.className = "role-select";
  ROLE_OPTIONS.forEach(option => {
    const opt = document.createElement("option");
    opt.value = option.value;
    opt.textContent = option.label;
    select.appendChild(opt);
  });
  select.value = alumno.role || "";
  card.appendChild(select);

  const aplicarRol = (role) => {
    card.classList.remove("role-legal", "role-tech", "role-admin", "role-archivo", "role-economico");
    roleTag.className = "role-tag";
    roleTag.textContent = ROLE_LABELS[role] || "Sin perfil";
    if (role && ROLE_CLASSES[role]) {
      card.classList.add(ROLE_CLASSES[role]);
      roleTag.classList.add(ROLE_CLASSES[role]);
    }
  };

  aplicarRol(alumno.role || "");

  card.addEventListener("click", (event) => {
    if (event.target === select) return;
    card.classList.toggle("open");
    if (card.classList.contains("open")) {
      select.focus();
    }
  });

  select.addEventListener("click", (event) => {
    event.stopPropagation();
  });

  select.addEventListener("change", (event) => {
    const role = event.target.value;
    if (role) {
      userRoles.set(alumno.id, role);
    } else {
      userRoles.delete(alumno.id);
    }
    alumno.role = role;
    aplicarRol(role);
  });

  return card;
}

function habilitarDragAndDrop(teamBoard) {
  if (!teamBoard.dataset.dndReady) {
    teamBoard.addEventListener("dragstart", (event) => {
      const card = event.target.closest(".team-member");
      if (!card) return;
      event.dataTransfer.setData("text/plain", card.dataset.student);
      event.dataTransfer.effectAllowed = "move";
      card.classList.add("dragging");
    });

    teamBoard.addEventListener("dragend", (event) => {
      const card = event.target.closest(".team-member");
      if (card) card.classList.remove("dragging");
    });

    teamBoard.addEventListener("dragover", (event) => {
      const zone = event.target.closest(".team-dropzone");
      if (!zone) return;
      event.preventDefault();
      zone.classList.add("drag-over");
    });

    teamBoard.addEventListener("dragleave", (event) => {
      const zone = event.target.closest(".team-dropzone");
      if (!zone) return;
      if (!zone.contains(event.relatedTarget)) {
        zone.classList.remove("drag-over");
      }
    });

    teamBoard.addEventListener("drop", (event) => {
      const zone = event.target.closest(".team-dropzone");
      if (!zone) return;
      event.preventDefault();
      zone.classList.remove("drag-over");
      const studentId = event.dataTransfer.getData("text/plain");
      if (!studentId) return;
      const card = teamBoard.querySelector(
        `.team-member[data-student="${CSS.escape(studentId)}"]`
      );
      if (!card) return;
      const teamName = zone.dataset.team;
      if (teamName === "unassigned") {
        teamAssignments.delete(studentId);
      } else {
        teamAssignments.set(studentId, teamName);
      }
      zone.appendChild(card);
    });

    teamBoard.dataset.dndReady = "true";
  }
}

function renderizarPuntuaciones(){
  const resultados = calcularPuntuaciones(ultimoFiltrado);
  if (!resultados.length){
    contenidoPuntuaciones.innerHTML = `<div class="scores-empty">No hay alumnos con entregables o tests completados en el filtro actual.</div>`;
    return;
  }
  const rows = resultados.map(r=>`
    <tr>
      <td>${r.display}</td>
      <td>${r.entidad}</td>
      <td>${r.entregables}</td>
      <td>${r.tests}</td>
      <td><strong>${r.total}</strong></td>
    </tr>
  `).join("");
  contenidoPuntuaciones.innerHTML = `
    <table class="scores-table">
      <thead>
        <tr>
          <th>Alumno</th>
          <th>Entidad</th>
          <th>Entregables (1 p.)</th>
          <th>Tests (2 p.)</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody>
        ${rows}
      </tbody>
    </table>
    <div class="teams-section">
      <div class="teams-header">
        <h3>DistribuciÃ³n de equipos</h3>
        <div class="teams-controls">
          <label for="teamCount">Equipos:</label>
          <select id="teamCount">
            <option value="3">3 equipos</option>
            <option value="4">4 equipos</option>
          </select>
          <button id="suggestTeams" class="btn btn-primary btn-suggest" type="button">âœ¨ Sugerir equipos</button>
        </div>
      </div>
      <p class="teams-help">Arrastra a cada alumno hacia el equipo deseado o usa la sugerencia automÃ¡tica para repartirlos.</p>
      <div class="teams-board" id="teamsBoard"></div>
    </div>
  `;
  inicializarEquipos(resultados);
}

btnPuntuaciones.addEventListener("click", ()=>{
  renderizarPuntuaciones();
  modalPuntuaciones.classList.add("active");
});

cerrarPuntuaciones.addEventListener("click", ()=>{
  modalPuntuaciones.classList.remove("active");
});

modalPuntuaciones.addEventListener("click", (event)=>{
  if (event.target === modalPuntuaciones) {
    modalPuntuaciones.classList.remove("active");
  }
});


function resetFiltros(){
  usuarioSeleccionadoClick=null;
  promoSeleccionadaClick=null;
  actividadSeleccionadaClick=null;
  inputUsuario.value="";
  usuarioFiltroTexto="";
  contSugs.style.display="none";
  actualizarGraficos();
}
</script>

</body>
</html>
