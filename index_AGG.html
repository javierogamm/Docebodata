<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard Formaci√≥n (HTML puro)</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #f5f7fb;
      --surface: #ffffff;
      --surface-alt: #eef2f8;
      --primary: #1f6feb;
      --primary-dark: #174ea6;
      --accent: #14b8a6;
      --text: #0f172a;
      --muted: #64748b;
      --border: #e2e8f0;
      --radius: 16px;
      --radius-sm: 10px;
      --shadow: 0 24px 60px rgba(15, 23, 42, 0.12);
      --shadow-soft: 0 12px 30px rgba(15, 23, 42, 0.08);
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
      margin: 24px;
      background: var(--bg);
      color: var(--text);
    }

    h1 {
      font-size: 2rem;
      margin-bottom: 16px;
      letter-spacing: -0.5px;
    }

    h2, h3 {
      color: var(--text);
      margin-top: 0;
    }

    #filtros {
      margin: 20px 0 24px;
      display:flex;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
    }

    .buscador {
      position: relative;
      display:inline-flex;
      align-items:center;
      gap:6px;
      border:1px solid var(--border);
      padding:8px 12px;
      border-radius:var(--radius-sm);
      background:var(--surface);
      box-shadow: var(--shadow-soft);
    }

    .buscador input {
      border:none;
      outline:none;
      min-width:260px;
      font-size:0.95rem;
      background:transparent;
    }

    .sugerencias {
      position:absolute;
      top:100%;
      left:0;
      right:0;
      z-index:10;
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:var(--radius-sm);
      margin-top:6px;
      max-height:240px;
      overflow:auto;
      display:none;
      box-shadow: var(--shadow);
    }

    .sug-item {
      padding:10px 12px;
      cursor:pointer;
    }

    .sug-item:hover, .sug-item.active { background:var(--surface-alt); }
    .sug-muted { color:var(--muted); font-size:12px; }

    .btn {
      cursor:pointer;
      border:1px solid transparent;
      background:var(--surface-alt);
      padding:8px 14px;
      border-radius:var(--radius-sm);
      font-weight:600;
      color:var(--text);
      transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.2s ease;
      box-shadow: 0 6px 14px rgba(15, 23, 42, 0.08);
    }

    .btn:hover {
      transform: translateY(-1px);
      background:#e1e8f4;
    }

    .btn:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(31, 111, 235, 0.2);
    }

    .grafico {
      margin-top: 24px;
      background: var(--surface);
      border-radius: var(--radius);
      padding: 18px 20px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-soft);
    }

    .grid { display: grid; grid-template-columns: 1fr; gap: 18px; }
    .grid > div {
      border: 1px solid var(--border);
      padding: 12px;
      border-radius: var(--radius);
      background: var(--surface-alt);
      box-shadow: var(--shadow-soft);
    }
    .scrollable-chart {
      max-height: 360px;
      overflow-y: auto;
      padding-right: 6px;
    }
    .scrollable-chart > div {
      width: 100%;
    }

    .top-actions { display:flex; justify-content:flex-end; margin: 10px 0 20px; }
    .btn-primary {
      background: linear-gradient(135deg, var(--primary), #3a8dff);
      color:#fff;
      border:none;
      padding:10px 20px;
      font-weight:600;
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, #1c5dd9, #2f7df2);
    }

    .app-version { text-align:center; color:var(--muted); font-size:0.85rem; margin: 28px 0 12px; }

    input[type="file"] {
      padding: 10px 14px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      background: var(--surface);
      box-shadow: var(--shadow-soft);
      font-family: inherit;
    }

    input[type="file"]::file-selector-button {
      border: none;
      background: var(--primary);
      color: #fff;
      padding: 8px 12px;
      border-radius: 8px;
      margin-right: 12px;
      cursor: pointer;
    }

    .modal-backdrop {
      position: fixed; inset:0; background: rgba(15, 23, 42, 0.55);
      backdrop-filter: blur(6px);
      display:none; align-items:center; justify-content:center; z-index:2000;
    }
    .modal-backdrop.active { display:flex; }
    .modal {
      background:var(--surface); width:min(1400px, 96vw); max-height:90vh; overflow:auto;
      border-radius:20px; padding:24px 28px; box-shadow:var(--shadow); border: 1px solid var(--border);
    }
    .modal-header { display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .modal-header h2 { margin:0; font-size:1.4rem; }
    .modal-close {
      background: var(--surface-alt);
      border:none; font-size:1.1rem; cursor:pointer;
      border-radius: 10px; padding: 6px 10px;
    }
    .scores-table { width:100%; border-collapse:collapse; margin-top:16px; }
    .scores-table th, .scores-table td { padding:10px 12px; border-bottom:1px solid var(--border); text-align:left; }
    .scores-table th { background:var(--surface-alt); position:sticky; top:0; z-index:1; }
    .scores-empty { padding:20px 0; color:var(--muted); text-align:center; }
    .teams-section { margin-top:24px; border-top:1px solid var(--border); padding-top:18px; }
    .teams-header { display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:12px; }
    .teams-header h3 { margin:0; color:var(--text); }
    .teams-controls { display:flex; align-items:center; gap:8px; }
    .teams-controls select { padding:6px 10px; border-radius:var(--radius-sm); border:1px solid var(--border); background: var(--surface); }
    .btn-suggest { padding:8px 12px; }
    .teams-help { margin:8px 0 0; color:var(--muted); font-size:0.92rem; }
    .teams-board { display:grid; grid-template-columns:repeat(auto-fit, minmax(220px, 1fr)); gap:14px; margin-top:12px; }
    .team-column {
      border:1px solid var(--border);
      border-radius:var(--radius);
      background:var(--surface-alt);
      padding:12px; min-height:220px; display:flex; flex-direction:column;
      box-shadow: var(--shadow-soft);
    }
    .team-column h4 { margin:0 0 10px; font-size:1rem; color:var(--text); }
    .team-dropzone { flex:1; display:flex; flex-direction:column; gap:8px; min-height:120px; padding:6px; border-radius:12px; }
    .team-dropzone.drag-over { border:2px dashed var(--primary); background: rgba(31, 111, 235, 0.08); }
    .team-member {
      padding:10px 12px; background:var(--surface); border:1px solid var(--border);
      border-radius:12px; cursor:grab; box-shadow:0 6px 16px rgba(15, 23, 42, 0.12);
      transition: transform 0.1s ease;
    }
    .team-member:hover { transform: translateY(-1px); }
    .team-member:active { cursor:grabbing; }
    .team-member.dragging { opacity:0.5; }
    .team-member.auto-assign { animation: autoDrop 0.3s ease; }
    .team-member.open { cursor:default; }
    .member-name { font-weight:600; color:var(--text); }
    .role-tag { margin-top:4px; font-size:0.78rem; color:var(--muted); }
    .role-tag.role-legal { color:#41548b; background:#e8edff; border-radius:999px; padding:2px 8px; display:inline-block; }
    .role-tag.role-tech { color:#1f6b6b; background:#dff7f4; border-radius:999px; padding:2px 8px; display:inline-block; }
    .role-tag.role-admin { color:#7a5c26; background:#fff4d6; border-radius:999px; padding:2px 8px; display:inline-block; }
    .role-tag.role-archivo { color:#5b3c9d; background:#f0e9ff; border-radius:999px; padding:2px 8px; display:inline-block; }
    .role-tag.role-economico { color:#1c7f4f; background:#e3f7ed; border-radius:999px; padding:2px 8px; display:inline-block; }
    .role-select { margin-top:6px; width:100%; padding:6px 8px; border-radius:8px; border:1px solid var(--border); font-size:0.82rem; display:none; background: var(--surface); }
    .team-member.open .role-select { display:block; }
    .team-member.role-legal { border-color:#c7d4ff; background:#f5f7ff; }
    .team-member.role-tech { border-color:#b8efe8; background:#f1fbfa; }
    .team-member.role-admin { border-color:#f3e0b2; background:#fff9ec; }
    .team-member.role-archivo { border-color:#d7c8f5; background:#f8f4ff; }
    .team-member.role-economico { border-color:#bfe8d3; background:#f2fbf6; }
    .team-dropzone.auto-assign { background: rgba(20, 184, 166, 0.12); transition: background 0.3s ease; }
    @keyframes autoDrop {
      from { transform: translateY(-8px); opacity:0.6; }
      to { transform: translateY(0); opacity:1; }
    }
    @media (max-width: 960px){
      .grid { grid-template-columns: 1fr; }
      .buscador input { min-width:160px; }
    }
  </style>
</head>
<body>

  <h1>Dashboard de Formaci√≥n</h1>

  <div class="top-actions">
    <button id="btnPuntuaciones" class="btn btn-primary">üìå Ver puntuaciones</button>
  </div>

  <input type="file" id="input-excel" accept=".csv,.xlsx,.xls" />
  <div id="filtros" style="display:none;">
    <div class="buscador" title="Filtra por NIF o nombre (contiene)">
      <span>üîé</span>
      <input id="buscaUsuario" type="text" placeholder="Buscar usuario (NIF o nombre)..." autocomplete="off" />
      <button id="clearUsuario" class="btn" title="Limpiar">‚úñ</button>
      <div id="sugerencias" class="sugerencias"></div>
    </div>

    <label for="tutor">Tutor: </label>
    <select id="tutor"><option value="all">Todos</option></select>

    <button class="btn" onclick="resetFiltros()">Quitar filtros</button>
  </div>

  <!-- Arriba: solo Promos -->
  <div class="grafico">
    <h2>% Completado por Promoci√≥n</h2>
    <div id="graficoPromos"></div>
  </div>

  <!-- Debajo usuarios -->
  <div class="grafico">
    <h2>% de Finalizaci√≥n por Usuario</h2>
    <div id="graficoUsuarios"></div>
  </div>
  
  
  <!-- % completado por bloque -->
  <div class="grafico">
    <h2>% Completado por Bloque</h2>
    <div id="graficoBloques"></div>
  </div>

  <div class="grafico">
    <h2>Entregables: % de finalizaci√≥n</h2>
    <div id="graficoEntregables"></div>
  </div>

  <!-- 5 gr√°ficos de materiales por bloque -->
  <div class="grafico">
      <h2>% de Finalizaci√≥n por Material (Agrupado por Bloques)</h2>
    <div class="grid">
      <div><h3>BLOQUE 1: GENERAL</h3><div class="scrollable-chart"><div id="graficoMat_B1"></div></div></div>
      <div><h3>BLOQUE 2: GDA</h3><div class="scrollable-chart"><div id="graficoMat_B2"></div></div></div>
      <div><h3>BLOQUE 3: REGLADA</h3><div class="scrollable-chart"><div id="graficoMat_B3"></div></div></div>
      <div><h3>BLOQUE 4: ECON√ìMICA</h3><div class="scrollable-chart"><div id="graficoMat_B4"></div></div></div>
      <div><h3>BLOQUE 5: ANAL√çTICA</h3><div class="scrollable-chart"><div id="graficoMat_B5"></div></div></div>
    </div>
  </div>

  <div class="app-version" id="appVersion"></div>

  <div id="modalPuntuaciones" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="tituloPuntuaciones">
    <div class="modal">
      <div class="modal-header">
        <h2 id="tituloPuntuaciones">Puntuaciones de alumnos filtrados</h2>
        <button class="modal-close" id="cerrarPuntuaciones" aria-label="Cerrar">‚úñ</button>
      </div>
      <div id="contenidoPuntuaciones"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="blocks.js"></script>
  <script>
    let datos = [];
    let usuarioSeleccionadoClick = null;   // selecci√≥n por clic en gr√°fico
    let promoSeleccionadaClick = null;
    let bloqueSeleccionadoClick = null;
    let ultimoFiltrado = [];
    const APP_VERSION = "1.0.12";
    const TEAM_CONFIG = {
      3: ["Equipo Rojo", "Equipo Marr√≥n", "Equipo Verde"],
      4: ["Equipo Rojo", "Equipo Marr√≥n", "Equipo Verde", "Equipo Ladrillosco"]
    };
    let teamCount = 3;
    let teamAssignments = new Map();
    let userRoles = new Map();

    // √çndice de usuarios para sugerencias: {id: {id, nombre, tutor, display, normId, normNombre, normDisplay}}
    let userIndex = {};
    let userList = []; // array de ids
    let usuarioFiltroTexto = ""; // texto libre del buscador
    let sugActiveIndex = -1; // item activo (teclas ‚Üë/‚Üì)

    // Colores
    const colores = {
      azulOscuro: "#004c6d",
      azulMedio: "#00718f",
      turquesa: "#00a5b3",
      grisClaro: "#cccccc",
      grisOscuro: "#666666"
    };
    const ROLE_OPTIONS = [
      { value: "", label: "Sin perfil" },
      { value: "legal", label: "Perfil Jur√≠dico", className: "role-legal" },
      { value: "tech", label: "Perfil Inform√°tico", className: "role-tech" },
      { value: "admin", label: "Perfil Administrativo", className: "role-admin" },
      { value: "archivo", label: "Perfil Archivo", className: "role-archivo" },
      { value: "economico", label: "Perfil Econ√≥mico", className: "role-economico" }
    ];
    const ROLE_LABELS = ROLE_OPTIONS.reduce((acc, item) => {
      acc[item.value] = item.label;
      return acc;
    }, {});
    const ROLE_CLASSES = ROLE_OPTIONS.reduce((acc, item) => {
      if (item.className) acc[item.value] = item.className;
      return acc;
    }, {});

    // === Exclusiones de "T√≠tulo del material de formaci√≥n" ===
    const EXCLUSIONES_CRUDAS = [
      "Test",
      "Tarea-formulario \"Revisi√≥n de datos\"",
      "Presentaci√≥n Taller online 5. Configuraci√≥n de circuitos de resoluci√≥n plurales",
      "Modelo de datos (Tesauros)",
      "Entidad 4. ARB con detalle (punto 8¬∫ del doc.)",
      "Tarea-documento \"Requerimiento\"",
      "Recurso pr√°ctico: C√≥mo pintar diagramas en formato BPMN",
      "Procedimiento de venta ambulante (expediente esPublico)",
      "Ideas clave del Canal de Denuncias",
      "Tabla configuraci√≥n campos del Tesauro",
      "Presentaci√≥n Taller online 9. B√∫squedas avanzadas: conceptos y opciones disponibles",
      "Identificaci√≥n de campos del tesauro en Informe",
      "Recurso encadenados",
      "Entidad 3. Bases de ejecuci√≥n desactualizadas",
      "Indicadores calidad configuraci√≥n del cat√°logo",
      "Notificaci√≥n individualizada",
      "Presentaci√≥n Taller online 3. Construcci√≥n de documentos inteligentes",
      "Documento necesario para la Tarea. Ejercicio pr√°ctico plantilla tesauros",
      "Listado con actuaciones de control",
      "Presentaci√≥n Taller online 7. M√≥dulo de dise√±o",
      "PPT Taller 02 Definici√≥n y configuraci√≥n de Activos sem√°nticos",
      "Presentaci√≥n Taller online 1. Contextualizaci√≥n y configuraci√≥n del cat√°logo",
      "Taller 03. Excel generador de condicionales",
      "Tarea-documento \"Informe t√©cnico\"",
      "Presentaci√≥n Taller online 10. Analiza: conceptos y primeros pasos de configuraci√≥n",
      "Ficha de descripci√≥n b√°sica de procedimientos",
      "Presentaci√≥n Taller online 4. Configuraci√≥n de circuitos de resoluci√≥n singulares",
      "Presentaci√≥n Taller online 6. Simplificaci√≥n administrativa",
      "Presentaci√≥n Taller online 8. Circuitos de resoluci√≥n con gasto",
      "Identificaci√≥n de campos del tesauro en Instancia",
      "Entidad 3. Remisi√≥n gen√©rica ACM"
    ];

    const normaliza = s => (s || "")
      .toString()
      .toLowerCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
      .replace(/\s+/g, " ")
      .trim();
    const ENTREGABLE_REGEX = /(?:entregable|tarea|actividades|taller)[^\d]*(\d+)/i;
    const ENTREGABLES_EXTRA = [
      "Tarea 1. Taller online 8",
      "Tarea 2. Taller online 8",
      "Actividades Taller 01 Busquedas avanzadas",
      "Actividades taller 02 gestiona analiza"
    ];
    const ENTREGABLES_EXTRA_NORM = new Set(ENTREGABLES_EXTRA.map(normaliza));
    const esEntregable = (titulo = "") => /entregable/i.test(titulo) || ENTREGABLES_EXTRA_NORM.has(normaliza(titulo));
    const obtenerNumeroEntregable = (titulo = "") => {
      const match = titulo.match(ENTREGABLE_REGEX);
      return match ? parseInt(match[1], 10) : Number.POSITIVE_INFINITY;
    };

    function obtenerCampo(filas, keys) {
      for (const key of keys) {
        const value = filas.map(r => r[key]).find(v => v && v.trim());
        if (value) return value;
      }
      return "";
    }

    const EXCLUSIONES = new Set(EXCLUSIONES_CRUDAS.map(normaliza));

    function filaExcluidaPorTitulo(d) {
      const titulo = d["T√≠tulo del material de formaci√≥n"];
      if (!titulo) return false;
      return EXCLUSIONES.has(normaliza(titulo));
    }

    // === Exclusi√≥n por Promoci√≥n: excluir AAG01..AAG17 ===
    function extraePromoCodigo(promoRaw) {
      if (!promoRaw) return null;
      const m = promoRaw.toString().trim().match(/AAG(\d{1,2})/i);
      if (!m) return null;
      return { code: `AAG${m[1].padStart(2,'0')}`, num: parseInt(m[1], 10) };
    }

    function promoExcluida(d) {
      const p = extraePromoCodigo(d["Promoci√≥n"]);
      if (!p) return false;
      return p.num >= 1 && p.num <= 17; // EXCLUIR 1..17
    }

    function filaExcluida(d) { return filaExcluidaPorTitulo(d) || promoExcluida(d); }

    // ======= Agrupaciones (desde blocks.js) =======
    const AGRUPACIONES = window.AGRUPACIONES || {};
    const MAP_NORM_TITLE_TO_BLOCK = (() => {
      const m = {};
      Object.keys(AGRUPACIONES).forEach(b => {
        AGRUPACIONES[b].forEach(t => { m[normaliza(t)] = b; });
      });
      return m;
    })();

    // ======= DOM =======
    const inputExcel = document.getElementById("input-excel");
    const inputUsuario = document.getElementById("buscaUsuario");
    const btnClearUsuario = document.getElementById("clearUsuario");
    const contSugs = document.getElementById("sugerencias");
    const btnPuntuaciones = document.getElementById("btnPuntuaciones");
    const modalPuntuaciones = document.getElementById("modalPuntuaciones");
    const cerrarPuntuaciones = document.getElementById("cerrarPuntuaciones");
    const contenidoPuntuaciones = document.getElementById("contenidoPuntuaciones");

    document.getElementById("appVersion").textContent = `Versi√≥n ${APP_VERSION}`;

    inputExcel.addEventListener("change", handleFile);

    
    function handleFile(e) {
      const file = e.target.files[0];
      if (!file) return;
      const name = file.name.toLowerCase();
      const ext = name.split('.').pop();

      function postLoad() {
        construirIndiceUsuarios();
        inicializarFiltros();
        actualizarGraficos();
        document.getElementById("filtros").style.display = "flex";
      }

      function normalizeKeys(row) {
        const out = {};
        for (const [k, v] of Object.entries(row || {})) {
          const nk = (k || "")
            .replace(/^\uFEFF/, "")         // elimina BOM
            .replace(/^"+|"+$/g, "")        // quita comillas envolventes
            .trim();
          out[nk] = (typeof v === "string") ? v.trim() : v;
        }
        return out;
      }

      if (ext === "csv") {
        const reader = new FileReader();
        reader.onload = function(ev) {
          let text = ev.target.result;
          let parsed = Papa.parse(text, { header: true, skipEmptyLines: true });
          // Si detecta 1 sola columna, reintenta con ';' y/o reparando comillas dobles
          if (!parsed.meta.fields || parsed.meta.fields.length <= 1) {
            parsed = Papa.parse(text, { header: true, skipEmptyLines: true, delimiter: ';' });
            if (!parsed.meta.fields || parsed.meta.fields.length <= 1) {
              const repaired = text.replace(/^"|"$/g, "").replace(/""/g, '"');
              parsed = Papa.parse(repaired, { header: true, skipEmptyLines: true });
            }
          }
          datos = (parsed.data || []).map(normalizeKeys);
          postLoad();
        };
        reader.readAsText(file, "utf-8");
        return;
      }

      // Fallback: XLSX/XLS como antes
      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: "array" });
        const sheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];
        // Normaliza keys
        const raw = XLSX.utils.sheet_to_json(sheet);
        datos = raw.map(normalizeKeys);
        postLoad();
      };
      reader.readAsArrayBuffer(file);
    }
    

    // ======= Sugerencias =======
    function construirIndiceUsuarios() {
      userIndex = {};
      userList = [];
      const validRows = datos.filter(d => !filaExcluida(d));
      const ids = [...new Set(validRows.map(d => d["Nombre de usuario"]).filter(Boolean))];

      ids.forEach(id => {
        const filas = validRows.filter(d => d["Nombre de usuario"] === id);
        const nombre = (filas.map(r => r["Nombre completo"]).find(v => v && v.trim())) || "";
        const tutor = (filas.map(r => r["Tutor"]).find(v => v && v.trim())) || "";
        const entidad = obtenerCampo(filas, ["Entidad", "ENTIDAD"]);
        const display = nombre ? `${id} ‚Äî ${nombre}` : id;
        userIndex[id] = {
          id, nombre, tutor, entidad, display,
          normId: normaliza(id), normNombre: normaliza(nombre), normDisplay: normaliza(display)
        };
      });
      userList = Object.keys(userIndex).sort((a,b) => userIndex[a].normId.localeCompare(userIndex[b].normId));
    }

    function generarSugerencias(q) {
      const qn = normaliza(q);
      if (!qn) { contSugs.style.display = "none"; contSugs.innerHTML = ""; sugActiveIndex = -1; return; }
      const max = 8;
      const matches = [];
      for (const id of userList) {
        const u = userIndex[id];
        if (u.normId.includes(qn) || u.normNombre.includes(qn) || u.normDisplay.includes(qn)) {
          matches.push(u);
          if (matches.length >= max) break;
        }
      }
      if (!matches.length) { contSugs.style.display = "none"; contSugs.innerHTML = ""; sugActiveIndex = -1; return; }

      contSugs.innerHTML = matches.map((u, idx) =>
        `<div class="sug-item" data-id="${u.id}" data-idx="${idx}">
           <div>${u.display}</div>
           <div class="sug-muted">${u.tutor ? "Tutor: " + u.tutor : ""}</div>
         </div>`).join("");
      contSugs.style.display = "block";
      sugActiveIndex = -1;

      // Click handler
      [...contSugs.querySelectorAll(".sug-item")].forEach(el => {
        el.addEventListener("click", () => {
          const id = el.getAttribute("data-id");
          seleccionarUsuario(id, /*syncInput*/true);
        });
      });
    }

    function moverSeleccion(delta) {
      const items = contSugs.querySelectorAll(".sug-item");
      if (!items.length) return;
      if (sugActiveIndex >= 0) items[sugActiveIndex].classList.remove("active");
      sugActiveIndex = (sugActiveIndex + delta + items.length) % items.length;
      items[sugActiveIndex].classList.add("active");
      items[sugActiveIndex].scrollIntoView({ block: "nearest" });
    }

    inputUsuario.addEventListener("input", () => {
      usuarioFiltroTexto = inputUsuario.value;
      usuarioSeleccionadoClick = null; // desancla selecci√≥n fija
      generarSugerencias(usuarioFiltroTexto);
      actualizarGraficos();
    });

    inputUsuario.addEventListener("keydown", (e) => {
      if (contSugs.style.display !== "block") return;
      if (e.key === "ArrowDown") { e.preventDefault(); moverSeleccion(1); }
      else if (e.key === "ArrowUp") { e.preventDefault(); moverSeleccion(-1); }
      else if (e.key === "Enter") {
        if (sugActiveIndex >= 0) {
          const el = contSugs.querySelectorAll(".sug-item")[sugActiveIndex];
          if (el) seleccionarUsuario(el.getAttribute("data-id"), /*syncInput*/true);
        }
      } else if (e.key === "Escape") {
        contSugs.style.display = "none";
      }
    });

    document.addEventListener("click", (e) => {
      if (!e.target.closest(".buscador")) {
        contSugs.style.display = "none";
      }
    });

    btnClearUsuario.addEventListener("click", () => {
      inputUsuario.value = "";
      usuarioFiltroTexto = "";
      usuarioSeleccionadoClick = null;
      contSugs.style.display = "none";
      actualizarGraficos();
    });

    function seleccionarUsuario(id, syncInput=false) {
      if (!id || !userIndex[id]) return;
      usuarioSeleccionadoClick = id;
      if (syncInput) {
        inputUsuario.value = userIndex[id].display;
        usuarioFiltroTexto = "";
        contSugs.style.display = "none";
      }
      actualizarGraficos();
    }

    // ======= Filtros b√°sicos =======
    function inicializarFiltros() {
      const tutorSel = document.getElementById("tutor");
      tutorSel.innerHTML = '<option value="all">Todos</option>';
      [...new Set(datos.filter(d => !filaExcluida(d)).map(d => d["Tutor"]))].forEach(t => {
        if (t) {
          const opt = document.createElement("option");
          opt.value = t; opt.text = t; tutorSel.add(opt);
        }
      });
      tutorSel.addEventListener("change", actualizarGraficos);
    }

    // Devuelve set de usuarios por texto (contiene); null = sin filtro textual
    function usuariosCoincidentesPorTexto() {
      const q = normaliza(usuarioFiltroTexto);
      if (!q) return null;
      const set = new Set();
      for (const id of userList) {
        const u = userIndex[id];
        if (u.normId.includes(q) || u.normNombre.includes(q) || u.normDisplay.includes(q)) {
          set.add(id);
        }
      }
      return set;
    }

    // ================= L√ìGICA DE GR√ÅFICOS =================
    function actualizarGraficos() {
      const tutorSel = document.getElementById("tutor").value;
      const setUsuariosTexto = usuariosCoincidentesPorTexto();

      // PROMOS
      const promoAgg = {};
      datos.forEach(d => {
        if (filaExcluida(d)) return;

        // usuario (prioridad click > texto)
        if (usuarioSeleccionadoClick && d["Nombre de usuario"] !== usuarioSeleccionadoClick) return;
        if (!usuarioSeleccionadoClick && setUsuariosTexto && !setUsuariosTexto.has(d["Nombre de usuario"])) return;

        if (tutorSel !== "all" && d["Tutor"] !== tutorSel) return;

        const p = extraePromoCodigo(d["Promoci√≥n"]); if (!p) return;
        const promo = p.code;

        if (!promoAgg[promo]) promoAgg[promo] = { comp:0, total:0, usuarios:new Set() };

        if (d["Estado del material de formaci√≥n"] && d["Estado del material de formaci√≥n"].trim() !== "") {
          promoAgg[promo].total++;
          if (d["Estado del material de formaci√≥n"].toLowerCase().includes("complet")) promoAgg[promo].comp++;
        }
        promoAgg[promo].usuarios.add(d["Nombre de usuario"]);
      });

      const todasPromos = Object.keys(promoAgg).sort();
      let nombresPromos = todasPromos;
      if (promoSeleccionadaClick && todasPromos.includes(promoSeleccionadaClick)) nombresPromos = [promoSeleccionadaClick];

      const pctPromos = nombresPromos.map(p => {
        const a = promoAgg[p]; return a && a.total>0 ? (a.comp/a.total)*100 : 0;
      });
      const hoverTextPromos = nombresPromos.map(p => {
        const a = promoAgg[p] || {usuarios:new Set(), total:0, comp:0};
        return `Usuarios √∫nicos: ${a.usuarios.size}<br>Actividades con estado: ${a.total}<br>Completadas: ${a.comp}<br>%: ${a.total? (a.comp/a.total*100).toFixed(1):"0.0"}%`;
      });

      Plotly.newPlot("graficoPromos", [{
        x: nombresPromos, y: pctPromos, type: "bar", marker: {color: colores.turquesa},
        text: pctPromos.map(v => v.toFixed(1) + "%"), textposition: "inside",
        hovertemplate: "%{x}<br>%{text}<br>%{customdata}<extra></extra>", customdata: hoverTextPromos
      }], { title: "% Completado por Promoci√≥n", yaxis: {range:[0,100]}, clickmode: "event+select" });

      // Filtrado central
      const filtrados = datos.filter(d => {
        if (filaExcluida(d)) return false;
        if (usuarioSeleccionadoClick && d["Nombre de usuario"] !== usuarioSeleccionadoClick) return false;
        if (!usuarioSeleccionadoClick && setUsuariosTexto && !setUsuariosTexto.has(d["Nombre de usuario"])) return false;
        if (tutorSel !== "all" && d["Tutor"] !== tutorSel) return false;
        const p = extraePromoCodigo(d["Promoci√≥n"]); const promo = p ? p.code : null;
        if (nombresPromos.length && !nombresPromos.includes(promo)) return false;
        if (promoSeleccionadaClick && promo !== promoSeleccionadaClick) return false;
        return true;
      });
      ultimoFiltrado = filtrados;

      // BLOQUES
      const blockIds = {
        "BLOQUE 1: GENERAL": "graficoMat_B1",
        "BLOQUE 2: GDA": "graficoMat_B2",
        "BLOQUE 3: REGLADA": "graficoMat_B3",
        "BLOQUE 4: ECON√ìMICA": "graficoMat_B4",
        "BLOQUE 5: ANAL√çTICA": "graficoMat_B5"
      };
      const bloqueOrden = Object.keys(blockIds);

      const bloqueAgg = {};
      filtrados.forEach(d => {
        const titulo = d["T√≠tulo del material de formaci√≥n"]; if (!titulo) return;
        const b = MAP_NORM_TITLE_TO_BLOCK[normaliza(titulo)]; if (!b || !blockIds[b]) return;
        if (!bloqueAgg[b]) bloqueAgg[b] = { comp:0, total:0 };
        if (d["Estado del material de formaci√≥n"] && d["Estado del material de formaci√≥n"].trim() !== "") {
          bloqueAgg[b].total++;
          if (d["Estado del material de formaci√≥n"].toLowerCase().includes("complet")) bloqueAgg[b].comp++;
        }
      });

      let bloquesParaMostrar = bloqueOrden.slice();
      if (bloqueSeleccionadoClick && bloquesParaMostrar.includes(bloqueSeleccionadoClick)) bloquesParaMostrar = [bloqueSeleccionadoClick];

      const xBloques = bloquesParaMostrar;
      const yBloques = xBloques.map(b => {
        const a = bloqueAgg[b] || {comp:0,total:0}; return a.total>0 ? (a.comp/a.total)*100 : 0;
      });
      const hoverBloques = xBloques.map(b => {
        const a = bloqueAgg[b] || {comp:0,total:0};
        return `Materiales con estado: ${a.total}<br>Completadas: ${a.comp}<br>%: ${a.total? (a.comp/a.total*100).toFixed(1):"0.0"}%`;
      });

      Plotly.newPlot("graficoBloques", [{
        x: xBloques, y: yBloques, type:"bar", marker:{color: colores.azulMedio},
        text: yBloques.map(v => v.toFixed(1)+"%"), textposition:"inside",
        hovertemplate: "%{x}<br>%{text}<br>%{customdata}<extra></extra>", customdata: hoverBloques
      }], { title:"% Completado por Bloque", yaxis:{range:[0,100]}, clickmode:"event+select" });

      // ENTREGABLES
      const entregablesContainer = document.getElementById("graficoEntregables");
      if (entregablesContainer) {
        const entregablesUnicos = [
          ...new Set([
            ...Object.values(AGRUPACIONES).flat().filter(esEntregable),
            ...ENTREGABLES_EXTRA
          ])
        ];
        const entregablesOrdenados = entregablesUnicos
          .slice()
          .sort((a, b) => {
            const numA = obtenerNumeroEntregable(a);
            const numB = obtenerNumeroEntregable(b);
            if (numA !== numB) return numA - numB;
            return a.localeCompare(b, "es");
          });
        const entregableNormMap = new Map(
          entregablesOrdenados.map(titulo => [normaliza(titulo), titulo])
        );
        const entregableStats = {};

        filtrados.forEach(d => {
          const mat = d["T√≠tulo del material de formaci√≥n"];
          const usu = d["Nombre de usuario"];
          if (!mat || !usu) return;
          const canon = entregableNormMap.get(normaliza(mat));
          if (!canon) return;
          if (!entregableStats[canon]) entregableStats[canon] = { tot: new Set(), comp: new Set() };
          entregableStats[canon].tot.add(usu);
          if (d["Estado del material de formaci√≥n"] && d["Estado del material de formaci√≥n"].toLowerCase().includes("complet")) {
            entregableStats[canon].comp.add(usu);
          }
        });

        const entregableLabels = entregablesOrdenados.filter(t => entregableStats[t] && entregableStats[t].tot.size > 0);
        if (!entregableLabels.length) {
          entregablesContainer.innerHTML = `<div class="scores-empty">No hay entregables disponibles con los filtros actuales.</div>`;
        } else {
          entregablesContainer.innerHTML = "";
          const xEnt = [];
          const yEnt = [];
          const textEnt = [];
          const hoverEnt = [];

          entregableLabels.forEach(t => {
            const s = entregableStats[t];
            const pct = s.tot.size ? (s.comp.size / s.tot.size) * 100 : 0;
            xEnt.push(pct);
            yEnt.push(t);
            textEnt.push(`${pct.toFixed(1)}%`);
            hoverEnt.push(`Usuarios con estado: ${s.tot.size}<br>Completados: ${s.comp.size}`);
          });

          const plotHeight = Math.max(240, yEnt.length * 32 + 80);
          Plotly.newPlot("graficoEntregables", [{
            x: xEnt, y: yEnt, type:"bar", orientation:"h",
            marker:{color: colores.accent || colores.turquesa},
            text:textEnt, textposition:"inside",
            hovertemplate: "%{y}<br>%{text}<br>%{customdata}<extra></extra>",
            customdata: hoverEnt
          }], {
            title:"",
            height: plotHeight,
            xaxis:{range:[0,100], automargin:true},
            yaxis:{automargin:true}
          });
        }
      }

      // MATERIALES por bloque
      const bloquesParaGraficar = bloqueSeleccionadoClick ? [bloqueSeleccionadoClick] : bloqueOrden;
      bloqueOrden.forEach(b => { const el = document.getElementById(blockIds[b]); if (el) el.innerHTML=""; });

      bloquesParaGraficar.forEach(b => {
        const containerId = blockIds[b];
        const titles = (AGRUPACIONES[b] || []).slice();
        const matStats = {}; // title -> {tot:Set, comp:Set}

        filtrados.forEach(d => {
          const mat = d["T√≠tulo del material de formaci√≥n"], usu = d["Nombre de usuario"];
          if (!mat || !usu) return;
          const bMap = MAP_NORM_TITLE_TO_BLOCK[normaliza(mat)];
          if (bMap !== b) return;
          if (!matStats[mat]) matStats[mat] = {tot:new Set(), comp:new Set()};
          matStats[mat].tot.add(usu);
          if (d["Estado del material de formaci√≥n"] && d["Estado del material de formaci√≥n"].toLowerCase().includes("complet")) {
            matStats[mat].comp.add(usu);
          }
        });

        const x=[], y=[], texts=[];
        titles.forEach(t => {
          const s = matStats[t]; if (!s || s.tot.size===0) return;
          const pct = (s.comp.size/s.tot.size)*100;
          y.push(t); x.push(pct); texts.push(pct.toFixed(1)+"%");
        });

        const plotHeight = Math.max(220, y.length * 28 + 80);
        Plotly.newPlot(containerId, [{
          x, y, type:"bar", orientation:"h", name:b,
          marker:{color: colores.turquesa}, text:texts, textposition:"inside"
        }], {
          title:"",
          height: plotHeight,
          xaxis:{range:[0,100], automargin:true},
          yaxis:{automargin:true}
        });
      });

      // USUARIOS
      const usuarios = {};
      filtrados.forEach(d => {
        const u = d["Nombre de usuario"]; if (!u) return;
        if (!usuarios[u]) usuarios[u] = { total:0, completados:0 };
        if (d["Estado del material de formaci√≥n"] && d["Estado del material de formaci√≥n"].trim() !== "") {
          usuarios[u].total++; if (d["Estado del material de formaci√≥n"].toLowerCase().includes("complet")) usuarios[u].completados++;
        }
      });

      const usuariosOrdenados = Object.keys(usuarios);
      const nombresUsuarios = usuariosOrdenados.map(u => {
        const meta = userIndex[u] || { nombre: u, tutor: "" };
        const nombreAlumno = meta.nombre || u;
        const tutorTxt = meta.tutor ? ` (${meta.tutor})` : "";
        return `${nombreAlumno}${tutorTxt}`;
      });

      const completadoUsu = usuariosOrdenados.map(u => {
        const s = usuarios[u]; return s.total>0 ? (s.completados/s.total)*100 : 0;
      });
      const noCompletadoUsu = completadoUsu.map(v => 100 - v);

      Plotly.newPlot("graficoUsuarios", [
        { x:nombresUsuarios, y:completadoUsu, name:"Completado", type:"bar", marker:{color: colores.turquesa},
          text: completadoUsu.map(p=>p.toFixed(1)+"%"), textposition:"inside" },
        { x:nombresUsuarios, y:noCompletadoUsu, name:"No Completado", type:"bar", marker:{color: colores.grisClaro},
          text: noCompletadoUsu.map(p=>p.toFixed(1)+"%"), textposition:"inside" }
      ], { title:"% Finalizaci√≥n por Usuario", barmode:"stack", yaxis:{range:[0,100]}, xaxis:{automargin:true} });

      // Cross-filters
      document.getElementById("graficoPromos").on('plotly_click', (ev)=>{
        const clicked = ev.points[0].x;
        promoSeleccionadaClick = (promoSeleccionadaClick === clicked) ? null : clicked;
        actualizarGraficos();
      });

      document.getElementById("graficoUsuarios").on('plotly_click', (ev)=>{
        const idx = ev.points[0].pointIndex;
        const userId = usuariosOrdenados[idx];
        seleccionarUsuario(userId, /*syncInput*/true);
      });

      document.getElementById("graficoBloques").on('plotly_click', (ev)=>{
        const clickedBlock = ev.points[0].x;
        bloqueSeleccionadoClick = (bloqueSeleccionadoClick === clickedBlock) ? null : clickedBlock;
        actualizarGraficos();
      });
      // === TESTS: materiales cuyo t√≠tulo contiene "Test" ===
      // crea contenedor solo una vez
  let cont = document.getElementById("graficoTests");
  if (!cont) {
    const div = document.createElement("div");
    div.className = "grafico";
    div.innerHTML = `<h2>% de Finalizaci√≥n en TESTS</h2><div id="graficoTests"></div>`;
    document.body.appendChild(div);
    cont = document.getElementById("graficoTests");
  }
      const testsAgg = {}; // t√≠tulo -> {tot:Set, comp:Set}

      filtrados.forEach(d => {
        const titulo = d["T√≠tulo del material de formaci√≥n"];
        const user = d["Nombre de usuario"];
        if (!titulo || !user) return;
        if (!/test/i.test(titulo)) return; // solo materiales con "test"
        if (!testsAgg[titulo]) testsAgg[titulo] = { tot: new Set(), comp: new Set() };
        testsAgg[titulo].tot.add(user);
        const estado = (d["Estado del material de formaci√≥n"] || "").toLowerCase();
        if (estado.includes("complet")) testsAgg[titulo].comp.add(user);
      });

        // === Orden y nombres personalizados de TESTS ===
        const ordenTests = [
        "Test final: Configuraci√≥n general de Gestiona",
        "Test final: Gesti√≥n documental y archivo",
        "Test final: Escritorio de tramitaci√≥n",
        "Test final: Tramitaci√≥n Reglada",
        "Test final: Actos plurales",
        "Test final: M√≥dulo de ejecuci√≥n",
        "Test final: Anal√≠tica de datos"
      ];

      const nombresCustom = {
        "Test final: Configuraci√≥n general de Gestiona": "01- Test final: Configuraci√≥n general de Gestiona",
        "Test final: Gesti√≥n documental y archivo": "02- Test final: Gesti√≥n documental y archivo",
        "Test final: Escritorio de tramitaci√≥n": "03- Test final: Escritorio de tramitaci√≥n",
        "Test final: Tramitaci√≥n Reglada": "04- Test final: Tramitaci√≥n reglada",
        "Test final: Actos plurales": "05- Test final: Actos plurales",
        "Test final: M√≥dulo de ejecuci√≥n": "06- Test final: M√≥dulo de ejecuci√≥n",
        "Test final: Anal√≠tica de datos": "07- Test final: Anal√≠tica de datos"
      };

      const xTests = [], completados = [], noCompletados = [];

      ordenTests.forEach(t => {
        const s = testsAgg[t];
        if (!s) return;
        const total = s.tot.size;
        const comp = s.comp.size;
        if (total > 0) {
          const pct = (comp / total) * 100;
          xTests.push(nombresCustom[t] || t);
          completados.push(pct);
          noCompletados.push(100 - pct);
        }
      });

      // üîπ Si hay tests, graficamos
      if (xTests.length > 0) {
       

        Plotly.newPlot("graficoTests", [
          { x: xTests, y: completados, name: "Completado", type: "bar", marker: { color: colores.turquesa },
            text: completados.map(p => p.toFixed(1) + "%"), textposition: "inside" },
          { x: xTests, y: noCompletados, name: "No Completado", type: "bar", marker: { color: colores.grisClaro },
            text: noCompletados.map(p => p.toFixed(1) + "%"), textposition: "inside" }
        ], {
          title: "% de Finalizaci√≥n en TESTS",
          barmode: "stack",
          yaxis: { range: [0, 100] },
          xaxis: { automargin: true }
        });
      }


    }

    function calcularPuntuaciones(filtrados) {
      const puntuaciones = {};
      filtrados.forEach(d => {
        const usuario = d["Nombre de usuario"];
        const titulo = (d["T√≠tulo del material de formaci√≥n"] || "").toString();
        const estado = (d["Estado del material de formaci√≥n"] || "").toLowerCase();
        if (!usuario || !titulo || !estado.includes("complet")) return;

        const esEntregableActual = esEntregable(titulo);
        const esTest = /test/i.test(titulo);

        if (!puntuaciones[usuario]) {
          puntuaciones[usuario] = { entregables: new Set(), tests: new Set() };
        }
        if (esEntregableActual) {
          puntuaciones[usuario].entregables.add(titulo);
        }
        if (esTest) {
          puntuaciones[usuario].tests.add(titulo);
        }
      });

      return Object.keys(puntuaciones).map(usuario => {
        const datosUsuario = puntuaciones[usuario];
        const entregables = datosUsuario.entregables.size;
        const tests = datosUsuario.tests.size;
        const total = entregables * 1 + tests * 2;
        const meta = userIndex[usuario] || { display: usuario, entidad: "" };
        return {
          usuario,
          nombre: userIndex[usuario]?.nombre || "",
          display: meta.display,
          entidad: meta.entidad || "",
          entregables,
          tests,
          total
        };
      }).sort((a, b) => b.total - a.total || a.display.localeCompare(b.display));
    }

    function construirAsignacionSugerida(alumnos, teamNames) {
      const entityCounts = new Map();
      alumnos.forEach(alumno => {
        const key = normaliza(alumno.entidad || "");
        alumno.entidadKey = key;
        if (!key) return;
        entityCounts.set(key, (entityCounts.get(key) || 0) + 1);
      });

      const teamStats = new Map();
      const totalAlumnos = alumnos.length;
      const baseSize = Math.floor(totalAlumnos / teamNames.length);
      const extra = totalAlumnos % teamNames.length;
      const teamCaps = new Map();
      teamNames.forEach((team, index) => {
        teamStats.set(team, { score: 0, miembros: 0, entidades: new Set(), roles: new Map() });
        teamCaps.set(team, baseSize + (index < extra ? 1 : 0));
      });

      const assignments = new Map();
      const entidadPuedeRepetir = (key) => (entityCounts.get(key) || 0) > teamNames.length;

      const elegirEquipo = (alumno, preferredIndex = null) => {
        const allowRepeat = !alumno.entidadKey || entidadPuedeRepetir(alumno.entidadKey);
        const candidates = teamNames.filter(team => {
          const stats = teamStats.get(team);
          const cap = teamCaps.get(team);
          const hasSpace = stats.miembros < cap;
          return hasSpace && (allowRepeat || !stats.entidades.has(alumno.entidadKey));
        });
        const posibles = candidates.length ? candidates : teamNames.filter(team => {
          const stats = teamStats.get(team);
          return stats.miembros < teamCaps.get(team);
        });
        const fallback = posibles.length ? posibles : teamNames;
        if (preferredIndex !== null) {
          for (let offset = 0; offset < teamNames.length; offset += 1) {
            const team = teamNames[(preferredIndex + offset) % teamNames.length];
            if (fallback.includes(team)) return team;
          }
        }
        return fallback.reduce((best, team) => {
          const stats = teamStats.get(team);
          const bestStats = teamStats.get(best);
          if (alumno.role) {
            const roleCount = stats.roles.get(alumno.role) || 0;
            const bestRoleCount = bestStats.roles.get(alumno.role) || 0;
            if (roleCount !== bestRoleCount) {
              return roleCount < bestRoleCount ? team : best;
            }
          }
          if (stats.score !== bestStats.score) {
            return stats.score < bestStats.score ? team : best;
          }
          if (stats.miembros !== bestStats.miembros) {
            return stats.miembros < bestStats.miembros ? team : best;
          }
          return team;
        }, fallback[0]);
      };

      const ordenar = [...alumnos].sort((a, b) => b.score - a.score || a.nombre.localeCompare(b.nombre));
      const seedCount = Math.min(teamNames.length, ordenar.length);

      const asignar = (alumno, team) => {
        assignments.set(alumno.id, team);
        const stats = teamStats.get(team);
        stats.score += alumno.score;
        stats.miembros += 1;
        if (alumno.entidadKey) stats.entidades.add(alumno.entidadKey);
        if (alumno.role) {
          stats.roles.set(alumno.role, (stats.roles.get(alumno.role) || 0) + 1);
        }
      };

      for (let i = 0; i < seedCount; i += 1) {
        const alumno = ordenar[i];
        const team = elegirEquipo(alumno, i);
        asignar(alumno, team);
      }

      for (let i = seedCount; i < ordenar.length; i += 1) {
        const alumno = ordenar[i];
        const team = elegirEquipo(alumno);
        asignar(alumno, team);
      }

      return assignments;
    }

    function animarAutoAsignacion(teamBoard, assignments) {
      const cards = [...teamBoard.querySelectorAll(".team-member")];
      const cardsById = new Map(cards.map(card => [card.dataset.student, card]));
      const zones = new Map(
        [...teamBoard.querySelectorAll(".team-dropzone")].map(zone => [zone.dataset.team, zone])
      );
      let delay = 0;
      assignments.forEach((team, id) => {
        const card = cardsById.get(id);
        const zone = zones.get(team);
        if (!card || !zone) return;
        if (card.closest(".team-dropzone") !== zone) {
          zone.appendChild(card);
        }
        const localDelay = delay;
        setTimeout(() => {
          card.classList.add("auto-assign");
          zone.classList.add("auto-assign");
          setTimeout(() => {
            card.classList.remove("auto-assign");
            zone.classList.remove("auto-assign");
          }, 300);
        }, localDelay);
        delay += 60;
      });
    }

    function inicializarEquipos(resultados) {
      const alumnos = resultados.map(r => ({
        id: r.usuario,
        nombre: r.nombre || r.display,
        entidad: r.entidad,
        score: r.total,
        role: userRoles.get(r.usuario) || ""
      }));
      const teamSelect = document.getElementById("teamCount");
      const suggestButton = document.getElementById("suggestTeams");
      const teamBoard = document.getElementById("teamsBoard");
      if (!teamSelect || !teamBoard) return;

      teamSelect.value = String(teamCount);
      teamSelect.addEventListener("change", (event) => {
        teamCount = Number(event.target.value) || 3;
        renderizarTableroEquipos(teamBoard, alumnos);
      });

      if (suggestButton) {
        suggestButton.addEventListener("click", () => {
          const teamNames = TEAM_CONFIG[teamCount] || TEAM_CONFIG[3];
          teamAssignments = construirAsignacionSugerida(alumnos, teamNames);
          renderizarTableroEquipos(teamBoard, alumnos);
          animarAutoAsignacion(teamBoard, teamAssignments);
        });
      }

      renderizarTableroEquipos(teamBoard, alumnos);
    }

    function renderizarTableroEquipos(teamBoard, alumnos) {
      const teamNames = TEAM_CONFIG[teamCount] || TEAM_CONFIG[3];
      const alumnosIds = new Set(alumnos.map(a => a.id));

      teamAssignments = new Map(
        [...teamAssignments.entries()].filter(([id]) => alumnosIds.has(id))
      );
      for (const [id, team] of teamAssignments.entries()) {
        if (!teamNames.includes(team)) {
          teamAssignments.delete(id);
        }
      }

      const asignados = new Map();
      teamNames.forEach(team => asignados.set(team, []));
      const sinEquipo = [];

      alumnos.forEach(alumno => {
        const team = teamAssignments.get(alumno.id);
        if (team && asignados.has(team)) {
          asignados.get(team).push(alumno);
        } else {
          sinEquipo.push(alumno);
        }
      });

      teamBoard.innerHTML = "";
      teamBoard.appendChild(crearColumnaEquipo("Sin equipo", "unassigned", sinEquipo));
      teamNames.forEach(team => {
        teamBoard.appendChild(crearColumnaEquipo(team, team, asignados.get(team)));
      });

      habilitarDragAndDrop(teamBoard);
    }

    function crearColumnaEquipo(titulo, teamKey, alumnos) {
      const column = document.createElement("div");
      column.className = "team-column";

      const heading = document.createElement("h4");
      heading.textContent = titulo;
      column.appendChild(heading);

      const dropzone = document.createElement("div");
      dropzone.className = "team-dropzone";
      dropzone.dataset.team = teamKey;
      alumnos.forEach(alumno => {
        dropzone.appendChild(crearTarjetaAlumno(alumno));
      });
      column.appendChild(dropzone);

      return column;
    }

    function crearTarjetaAlumno(alumno) {
      const card = document.createElement("div");
      card.className = "team-member";
      card.draggable = true;
      card.dataset.student = alumno.id;
      const nombre = alumno.nombre || alumno.id;

      const nameLine = document.createElement("div");
      nameLine.className = "member-name";
      nameLine.textContent = alumno.entidad ? `${nombre} ‚Äî ${alumno.entidad}` : nombre;
      card.appendChild(nameLine);

      const roleTag = document.createElement("div");
      roleTag.className = "role-tag";
      card.appendChild(roleTag);

      const select = document.createElement("select");
      select.className = "role-select";
      ROLE_OPTIONS.forEach(option => {
        const opt = document.createElement("option");
        opt.value = option.value;
        opt.textContent = option.label;
        select.appendChild(opt);
      });
      select.value = alumno.role || "";
      card.appendChild(select);

      const aplicarRol = (role) => {
        card.classList.remove("role-legal", "role-tech", "role-admin", "role-archivo", "role-economico");
        roleTag.className = "role-tag";
        roleTag.textContent = ROLE_LABELS[role] || "Sin perfil";
        if (role && ROLE_CLASSES[role]) {
          card.classList.add(ROLE_CLASSES[role]);
          roleTag.classList.add(ROLE_CLASSES[role]);
        }
      };

      aplicarRol(alumno.role || "");

      card.addEventListener("click", (event) => {
        if (event.target === select) return;
        card.classList.toggle("open");
        if (card.classList.contains("open")) {
          select.focus();
        }
      });

      select.addEventListener("click", (event) => {
        event.stopPropagation();
      });

      select.addEventListener("change", (event) => {
        const role = event.target.value;
        if (role) {
          userRoles.set(alumno.id, role);
        } else {
          userRoles.delete(alumno.id);
        }
        alumno.role = role;
        aplicarRol(role);
      });

      return card;
    }

    function habilitarDragAndDrop(teamBoard) {
      if (!teamBoard.dataset.dndReady) {
        teamBoard.addEventListener("dragstart", (event) => {
          const card = event.target.closest(".team-member");
          if (!card) return;
          event.dataTransfer.setData("text/plain", card.dataset.student);
          event.dataTransfer.effectAllowed = "move";
          card.classList.add("dragging");
        });

        teamBoard.addEventListener("dragend", (event) => {
          const card = event.target.closest(".team-member");
          if (card) card.classList.remove("dragging");
        });

        teamBoard.addEventListener("dragover", (event) => {
          const zone = event.target.closest(".team-dropzone");
          if (!zone) return;
          event.preventDefault();
          zone.classList.add("drag-over");
        });

        teamBoard.addEventListener("dragleave", (event) => {
          const zone = event.target.closest(".team-dropzone");
          if (!zone) return;
          if (!zone.contains(event.relatedTarget)) {
            zone.classList.remove("drag-over");
          }
        });

        teamBoard.addEventListener("drop", (event) => {
          const zone = event.target.closest(".team-dropzone");
          if (!zone) return;
          event.preventDefault();
          zone.classList.remove("drag-over");
          const studentId = event.dataTransfer.getData("text/plain");
          if (!studentId) return;
          const card = teamBoard.querySelector(
            `.team-member[data-student="${CSS.escape(studentId)}"]`
          );
          if (!card) return;
          const teamName = zone.dataset.team;
          if (teamName === "unassigned") {
            teamAssignments.delete(studentId);
          } else {
            teamAssignments.set(studentId, teamName);
          }
          zone.appendChild(card);
        });

        teamBoard.dataset.dndReady = "true";
      }
    }

    function renderizarPuntuaciones() {
      const resultados = calcularPuntuaciones(ultimoFiltrado);
      if (!resultados.length) {
        contenidoPuntuaciones.innerHTML = `<div class="scores-empty">No hay alumnos con entregables o tests completados en el filtro actual.</div>`;
        return;
      }
      const rows = resultados.map(r => `
        <tr>
          <td>${r.display}</td>
          <td>${r.entidad}</td>
          <td>${r.entregables}</td>
          <td>${r.tests}</td>
          <td><strong>${r.total}</strong></td>
        </tr>
      `).join("");
      contenidoPuntuaciones.innerHTML = `
        <table class="scores-table">
          <thead>
            <tr>
              <th>Alumno</th>
              <th>Entidad</th>
              <th>Entregables (1 p.)</th>
              <th>Tests (2 p.)</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody>
            ${rows}
          </tbody>
        </table>
        <div class="teams-section">
          <div class="teams-header">
            <h3>Distribuci√≥n de equipos</h3>
            <div class="teams-controls">
              <label for="teamCount">Equipos:</label>
          <select id="teamCount">
            <option value="3">3 equipos</option>
            <option value="4">4 equipos</option>
          </select>
          <button id="suggestTeams" class="btn btn-primary btn-suggest" type="button">‚ú® Sugerir equipos</button>
        </div>
      </div>
          <p class="teams-help">Arrastra a cada alumno hacia el equipo deseado.</p>
          <div class="teams-board" id="teamsBoard"></div>
        </div>
      `;
      inicializarEquipos(resultados);
    }

    btnPuntuaciones.addEventListener("click", () => {
      renderizarPuntuaciones();
      modalPuntuaciones.classList.add("active");
    });

    cerrarPuntuaciones.addEventListener("click", () => {
      modalPuntuaciones.classList.remove("active");
    });

    modalPuntuaciones.addEventListener("click", (event) => {
      if (event.target === modalPuntuaciones) {
        modalPuntuaciones.classList.remove("active");
      }
    });
 
    function resetFiltros() {
      usuarioSeleccionadoClick = null;
      promoSeleccionadaClick = null;
      bloqueSeleccionadoClick = null;
      inputUsuario.value = "";
      usuarioFiltroTexto = "";
      contSugs.style.display = "none";
      inicializarFiltros();
      actualizarGraficos();
    }
  </script>

</body>
</html>
